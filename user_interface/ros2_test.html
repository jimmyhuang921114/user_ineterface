<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROS2 æ•´åˆæ¸¬è©¦ - é†«é™¢è—¥ç‰©ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }

        .test-section h2::before {
            content: 'ğŸ¤–';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .test-button:active {
            transform: translateY(0);
        }

        .result-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 5px solid #667eea;
        }

        .result-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #27ae60;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .result-item.error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .result-item .timestamp {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .result-item .content {
            font-family: 'Courier New', monospace;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy {
            background-color: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-error {
            background-color: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– ROS2 æ•´åˆæ¸¬è©¦ä¸­å¿ƒ</h1>
            <p>æ¸¬è©¦é†«é™¢è—¥ç‰©ç®¡ç†ç³»çµ±èˆ‡ROS2çš„å®Œæ•´æ•´åˆåŠŸèƒ½</p>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalOrders">-</h3>
                    <p>ç¸½è¨‚å–®æ•¸</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalPrescriptions">-</h3>
                    <p>è™•æ–¹ç±¤æ•¸</p>
                </div>
                <div class="stat-card">
                    <h3 id="systemStatus">-</h3>
                    <p>ç³»çµ±ç‹€æ…‹</p>
                </div>
            </div>
        </div>

        <!-- ROS2 è¨‚å–®æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ROS2 è¨‚å–®ç®¡ç†æ¸¬è©¦</h2>
            <div class="button-group">
                <button class="test-button" onclick="getROS2Orders()">ğŸ“‹ ç²å–æ‰€æœ‰ROS2è¨‚å–®</button>
                <button class="test-button" onclick="getROS2Order()">ğŸ” æŸ¥è©¢å–®ä¸€è¨‚å–®</button>
                <button class="test-button" onclick="updateROS2Status()">ğŸ”„ æ›´æ–°è¨‚å–®ç‹€æ…‹</button>
                <button class="test-button" onclick="getROS2Prescriptions()">ğŸ’Š ç²å–ROS2è™•æ–¹æ ¼å¼</button>
            </div>
            
            <div class="form-group">
                <label for="orderIdInput">è¨‚å–®ID (ç”¨æ–¼å–®ä¸€æŸ¥è©¢å’Œç‹€æ…‹æ›´æ–°):</label>
                <input type="text" id="orderIdInput" placeholder="ä¾‹å¦‚: ORDER_0001" value="ORDER_0001">
            </div>
            
            <div class="form-group">
                <label for="statusSelect">æ–°ç‹€æ…‹:</label>
                <select id="statusSelect">
                    <option value="pending">å¾…è™•ç† (pending)</option>
                    <option value="processing">è™•ç†ä¸­ (processing)</option>
                    <option value="completed">å·²å®Œæˆ (completed)</option>
                    <option value="failed">å¤±æ•— (failed)</option>
                    <option value="cancelled">å·²å–æ¶ˆ (cancelled)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="statusMessage">ç‹€æ…‹è¨Šæ¯:</label>
                <input type="text" id="statusMessage" placeholder="ä¾‹å¦‚: ROS2æ©Ÿå™¨äººæ­£åœ¨è™•ç†è¨‚å–®" value="ROS2æ©Ÿå™¨äººæ­£åœ¨è™•ç†è¨‚å–®">
            </div>

            <div class="result-container">
                <h3>ğŸ¤– ROS2 æ¸¬è©¦çµæœ</h3>
                <div id="ros2Results"></div>
            </div>
        </div>

        <!-- è™•æ–¹ç±¤å‰µå»ºæ¸¬è©¦ -->
        <div class="test-section">
            <h2>è™•æ–¹ç±¤å‰µå»ºæ¸¬è©¦</h2>
            <div class="button-group">
                <button class="test-button" onclick="createTestPrescription()">â• å‰µå»ºæ¸¬è©¦è™•æ–¹ç±¤</button>
                <button class="test-button" onclick="getAllPrescriptions()">ğŸ“‹ ç²å–æ‰€æœ‰è™•æ–¹ç±¤</button>
                <button class="test-button" onclick="checkSystemHealth()">â¤ï¸ ç³»çµ±å¥åº·æª¢æŸ¥</button>
            </div>

            <div class="result-container">
                <h3>ğŸ“‹ è™•æ–¹ç±¤æ¸¬è©¦çµæœ</h3>
                <div id="prescriptionResults"></div>
            </div>
        </div>

        <!-- å¯¦æ™‚ç›£æ§ -->
        <div class="test-section">
            <h2>å¯¦æ™‚ç‹€æ…‹ç›£æ§</h2>
            <div class="button-group">
                <button class="test-button" onclick="startMonitoring()">â–¶ï¸ é–‹å§‹ç›£æ§</button>
                <button class="test-button" onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›£æ§</button>
                <button class="test-button" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
            </div>

            <div class="result-container">
                <h3>ğŸ“Š å¯¦æ™‚ç›£æ§çµæœ</h3>
                <div id="monitoringResults"></div>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;

        // æ·»åŠ çµæœåˆ°å®¹å™¨
        function addResult(containerId, message, isError = false) {
            const container = document.getElementById(containerId);
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${isError ? 'error' : ''}`;
            
            const timestamp = new Date().toLocaleString('zh-TW');
            resultItem.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="content">${message}</div>
            `;
            
            container.insertBefore(resultItem, container.firstChild);
            
            // é™åˆ¶é¡¯ç¤ºçš„çµæœæ•¸é‡
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // æ ¼å¼åŒ–JSONé¡¯ç¤º
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        // ROS2 è¨‚å–®ç›¸é—œå‡½æ•¸
        async function getROS2Orders() {
            try {
                const response = await fetch('/api/ros2/orders');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('ros2Results', `âœ… æˆåŠŸç²å– ${data.total_orders} å€‹ROS2è¨‚å–®:\n${formatJSON(data)}`);
                    document.getElementById('totalOrders').textContent = data.total_orders;
                } else {
                    addResult('ros2Results', `âŒ ç²å–ROS2è¨‚å–®å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('ros2Results', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        async function getROS2Order() {
            const orderId = document.getElementById('orderIdInput').value;
            if (!orderId) {
                addResult('ros2Results', 'âŒ è«‹è¼¸å…¥è¨‚å–®ID', true);
                return;
            }

            try {
                const response = await fetch(`/api/ros2/orders/${orderId}`);
                const data = await response.json();
                
                if (response.ok) {
                    addResult('ros2Results', `âœ… æˆåŠŸç²å–è¨‚å–® ${orderId}:\n${formatJSON(data)}`);
                } else {
                    addResult('ros2Results', `âŒ ç²å–è¨‚å–®å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('ros2Results', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        async function updateROS2Status() {
            const orderId = document.getElementById('orderIdInput').value;
            const status = document.getElementById('statusSelect').value;
            const message = document.getElementById('statusMessage').value;

            if (!orderId) {
                addResult('ros2Results', 'âŒ è«‹è¼¸å…¥è¨‚å–®ID', true);
                return;
            }

            const statusData = {
                order_id: orderId,
                status: status,
                message: message,
                timestamp: new Date().toISOString().replace('T', ' ').slice(0, 19)
            };

            try {
                const response = await fetch('/api/ros2/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(statusData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('ros2Results', `âœ… æˆåŠŸæ›´æ–°è¨‚å–®ç‹€æ…‹:\n${formatJSON(data)}`);
                } else {
                    addResult('ros2Results', `âŒ æ›´æ–°ç‹€æ…‹å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('ros2Results', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        async function getROS2Prescriptions() {
            try {
                const response = await fetch('/api/ros2/prescription');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('ros2Results', `âœ… æˆåŠŸç²å–ROS2æ ¼å¼è™•æ–¹ç±¤:\n${formatJSON(data)}`);
                } else {
                    addResult('ros2Results', `âŒ ç²å–è™•æ–¹ç±¤å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('ros2Results', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        // è™•æ–¹ç±¤ç›¸é—œå‡½æ•¸
        async function createTestPrescription() {
            const testPrescription = {
                patient_name: `æ¸¬è©¦ç—…æ‚£_${Date.now()}`,
                patient_id: `P${Date.now()}`,
                doctor_name: "ROS2æ¸¬è©¦é†«å¸«",
                medicines: [
                    ["æ¸¬è©¦è—¥ç‰©ROS2_A", "2", "7", "ROS2æ¸¬è©¦ç”¨è—¥A"],
                    ["æ¸¬è©¦è—¥ç‰©ROS2_B", "1", "14", "ROS2æ¸¬è©¦ç”¨è—¥B"]
                ]
            };

            try {
                const response = await fetch('/api/prescription/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPrescription)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('prescriptionResults', `âœ… æˆåŠŸå‰µå»ºæ¸¬è©¦è™•æ–¹ç±¤:\n${formatJSON(data)}`);
                    // è‡ªå‹•æ›´æ–°çµ±è¨ˆ
                    setTimeout(getAllPrescriptions, 500);
                } else {
                    addResult('prescriptionResults', `âŒ å‰µå»ºè™•æ–¹ç±¤å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('prescriptionResults', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        async function getAllPrescriptions() {
            try {
                const response = await fetch('/api/prescription/');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('prescriptionResults', `âœ… æˆåŠŸç²å– ${data.prescriptions.length} å€‹è™•æ–¹ç±¤:\n${formatJSON(data)}`);
                    document.getElementById('totalPrescriptions').textContent = data.prescriptions.length;
                } else {
                    addResult('prescriptionResults', `âŒ ç²å–è™•æ–¹ç±¤å¤±æ•—: ${formatJSON(data)}`, true);
                }
            } catch (error) {
                addResult('prescriptionResults', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
            }
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    addResult('prescriptionResults', `âœ… ç³»çµ±å¥åº·æª¢æŸ¥é€šé:\n${formatJSON(data)}`);
                    document.getElementById('systemStatus').innerHTML = 
                        `<span class="status-indicator status-healthy"></span>å¥åº·`;
                } else {
                    addResult('prescriptionResults', `âŒ ç³»çµ±å¥åº·æª¢æŸ¥å¤±æ•—: ${formatJSON(data)}`, true);
                    document.getElementById('systemStatus').innerHTML = 
                        `<span class="status-indicator status-error"></span>ç•°å¸¸`;
                }
            } catch (error) {
                addResult('prescriptionResults', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
                document.getElementById('systemStatus').innerHTML = 
                    `<span class="status-indicator status-error"></span>éŒ¯èª¤`;
            }
        }

        // ç›£æ§ç›¸é—œå‡½æ•¸
        function startMonitoring() {
            if (monitoringInterval) {
                stopMonitoring();
            }

            addResult('monitoringResults', 'ğŸ”„ é–‹å§‹å¯¦æ™‚ç›£æ§...');
            
            monitoringInterval = setInterval(async () => {
                try {
                    // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                    const healthResponse = await fetch('/api/health');
                    const healthData = await healthResponse.json();
                    
                    // æª¢æŸ¥è¨‚å–®æ•¸é‡
                    const ordersResponse = await fetch('/api/ros2/orders');
                    const ordersData = await ordersResponse.json();
                    
                    // æª¢æŸ¥è™•æ–¹ç±¤æ•¸é‡
                    const prescriptionsResponse = await fetch('/api/prescription/');
                    const prescriptionsData = await prescriptionsResponse.json();
                    
                    const monitorData = {
                        timestamp: new Date().toLocaleString('zh-TW'),
                        system_status: healthData.status,
                        total_orders: ordersData.total_orders,
                        total_prescriptions: prescriptionsData.prescriptions.length,
                        features: healthData.features
                    };
                    
                    addResult('monitoringResults', `ğŸ“Š ç›£æ§æ•¸æ“š:\n${formatJSON(monitorData)}`);
                    
                    // æ›´æ–°çµ±è¨ˆå¡ç‰‡
                    document.getElementById('totalOrders').textContent = ordersData.total_orders;
                    document.getElementById('totalPrescriptions').textContent = prescriptionsData.prescriptions.length;
                    
                } catch (error) {
                    addResult('monitoringResults', `âŒ ç›£æ§éŒ¯èª¤: ${error.message}`, true);
                }
            }, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                addResult('monitoringResults', 'â¹ï¸ åœæ­¢å¯¦æ™‚ç›£æ§');
            }
        }

        function clearResults() {
            document.getElementById('ros2Results').innerHTML = '';
            document.getElementById('prescriptionResults').innerHTML = '';
            document.getElementById('monitoringResults').innerHTML = '';
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆå§‹æª¢æŸ¥
        window.onload = function() {
            checkSystemHealth();
            getROS2Orders();
            getAllPrescriptions();
        };

        // é é¢å¸è¼‰æ™‚åœæ­¢ç›£æ§
        window.onbeforeunload = function() {
            stopMonitoring();
        };
    </script>
</body>
</html>