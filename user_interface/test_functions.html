<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 功能測試頁面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.success {
            background: #27ae60;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 醫院管理系統功能測試</h1>
        <p>這個頁面用於測試所有核心功能是否正常運作。</p>

        <!-- 測試新增藥物 -->
        <div class="test-section">
            <h3>💊 測試新增藥物（統一表單）</h3>
            <div class="form-group">
                <label>藥物名稱:</label>
                <input type="text" id="testMedicineName" placeholder="例：測試藥物" value="功能測試藥物">
            </div>
            <div class="form-group">
                <label>數量:</label>
                <input type="number" id="testMedicineAmount" placeholder="100" value="100">
            </div>
            <div class="form-group">
                <label>儲存位置:</label>
                <input type="text" id="testMedicinePosition" placeholder="例：1-1" value="T-1">
            </div>
            <div class="form-group">
                <label>AI提示詞:</label>
                <textarea id="testMedicinePrompt" placeholder="AI提示詞">這是一個功能測試用的藥物</textarea>
            </div>
            <div class="form-group">
                <label>藥物描述:</label>
                <textarea id="testMedicineDescription" placeholder="藥物描述">詳細的功能測試描述</textarea>
            </div>
            <button class="btn" onclick="testAddMedicine()">🧪 測試新增藥物</button>
            <div id="addMedicineResult" class="result" style="display:none;"></div>
        </div>

        <!-- 測試開立處方 -->
        <div class="test-section">
            <h3>📋 測試開立處方籤</h3>
            <div class="form-group">
                <label>病患姓名:</label>
                <input type="text" id="testPatientName" placeholder="例：測試病人" value="功能測試病人">
            </div>
            <div class="form-group">
                <label>身份證號:</label>
                <input type="text" id="testPatientId" placeholder="A123456789" value="T123456789">
            </div>
            <div class="form-group">
                <label>藥物名稱:</label>
                <input type="text" id="testPrescMedicine" placeholder="從上面新增的藥物選擇" value="功能測試藥物">
            </div>
            <div class="form-group">
                <label>個數:</label>
                <input type="number" id="testPrescQuantity" placeholder="30" value="30">
            </div>
            <div class="form-group">
                <label>天數:</label>
                <input type="number" id="testPrescDays" placeholder="7" value="7">
            </div>
            <div class="form-group">
                <label>備註:</label>
                <input type="text" id="testPrescNotes" placeholder="飯後服用" value="測試備註">
            </div>
            <button class="btn" onclick="testCreatePrescription()">🧪 測試開立處方</button>
            <div id="createPrescResult" class="result" style="display:none;"></div>
        </div>

        <!-- 測試查詢功能 -->
        <div class="test-section">
            <h3>📊 測試查詢功能</h3>
            <button class="btn" onclick="testGetMedicines()">🧪 測試藥物查詢</button>
            <button class="btn" onclick="testGetPrescriptions()">🧪 測試處方籤查詢</button>
            <div id="queryResult" class="result" style="display:none;"></div>
        </div>

        <!-- 測試頁面連結 -->
        <div class="test-section">
            <h3>🔗 頁面導航測試</h3>
            <p>點擊以下按鈕測試各個頁面是否正常載入：</p>
            <button class="btn" onclick="window.open('/doctor.html', '_blank')">👨‍⚕️ 醫生工作台</button>
            <button class="btn" onclick="window.open('/integrated_medicine_management.html', '_blank')">🔧 整合管理</button>
            <button class="btn" onclick="window.open('/Prescription.html', '_blank')">📋 處方籤管理</button>
            <button class="btn" onclick="window.open('/Medicine.html', '_blank')">💊 藥物管理</button>
        </div>

        <!-- 結果摘要 -->
        <div class="test-section">
            <h3>📋 測試結果摘要</h3>
            <div id="testSummary"></div>
            <button class="btn success" onclick="runAllTests()">🚀 執行完整測試</button>
        </div>
    </div>

    <script>
        let testResults = [];

        async function testAddMedicine() {
            const resultDiv = document.getElementById('addMedicineResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 測試中...';

            try {
                const testData = {
                    basic_data: {
                        name: document.getElementById('testMedicineName').value,
                        amount: parseInt(document.getElementById('testMedicineAmount').value),
                        position: document.getElementById('testMedicinePosition').value,
                        prompt: document.getElementById('testMedicinePrompt').value
                    },
                    detailed_data: {
                        description: document.getElementById('testMedicineDescription').value
                    }
                };

                const response = await fetch('/api/medicine/unified', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 新增藥物成功！<br>藥物名稱: ${result.basic_medicine.name}<br>AI提示: ${result.basic_medicine.prompt}`;
                    testResults.push({test: '新增藥物', status: '成功'});
                } else {
                    throw new Error(result.detail || '新增失敗');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 測試失敗: ${error.message}`;
                testResults.push({test: '新增藥物', status: '失敗', error: error.message});
            }
        }

        async function testCreatePrescription() {
            const resultDiv = document.getElementById('createPrescResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 測試中...';

            try {
                const testData = {
                    patient_name: document.getElementById('testPatientName').value,
                    patient_id: 'P' + Date.now(),
                    doctor_name: '測試醫生',
                    medicines: [[
                        document.getElementById('testPrescMedicine').value,
                        document.getElementById('testPrescQuantity').value,
                        document.getElementById('testPrescDays').value,
                        document.getElementById('testPrescNotes').value
                    ]]
                };

                const response = await fetch('/api/prescription/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 開立處方成功！<br>病人: ${result.prescription.patient_name}<br>藥物數量: ${result.prescription.medicines.length}種`;
                    testResults.push({test: '開立處方', status: '成功'});
                } else {
                    throw new Error(result.detail || '開立失敗');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 測試失敗: ${error.message}`;
                testResults.push({test: '開立處方', status: '失敗', error: error.message});
            }
        }

        async function testGetMedicines() {
            const resultDiv = document.getElementById('queryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 查詢藥物中...';

            try {
                const response = await fetch('/api/medicine/basic');
                const result = await response.json();

                if (response.ok) {
                    const medicines = result.medicines || [];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 藥物查詢成功！<br>共找到 ${medicines.length} 種藥物<br>最新藥物: ${medicines[medicines.length - 1]?.name || '無'}`;
                    testResults.push({test: '藥物查詢', status: '成功'});
                } else {
                    throw new Error('查詢失敗');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 查詢失敗: ${error.message}`;
                testResults.push({test: '藥物查詢', status: '失敗', error: error.message});
            }
        }

        async function testGetPrescriptions() {
            const resultDiv = document.getElementById('queryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '🔄 查詢處方籤中...';

            try {
                const response = await fetch('/api/prescription/');
                const result = await response.json();

                if (response.ok) {
                    const prescriptions = result.prescriptions || [];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 處方籤查詢成功！<br>共找到 ${prescriptions.length} 張處方籤`;
                    testResults.push({test: '處方籤查詢', status: '成功'});
                } else {
                    throw new Error('查詢失敗');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ 查詢失敗: ${error.message}`;
                testResults.push({test: '處方籤查詢', status: '失敗', error: error.message});
            }
        }

        async function runAllTests() {
            testResults = [];
            updateTestSummary();
            
            await testAddMedicine();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCreatePrescription();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGetMedicines();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGetPrescriptions();
            
            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            if (testResults.length === 0) {
                summaryDiv.innerHTML = '📋 尚未執行測試';
                return;
            }

            const successful = testResults.filter(r => r.status === '成功').length;
            const failed = testResults.filter(r => r.status === '失敗').length;
            
            let html = `<h4>測試結果統計:</h4>`;
            html += `<p>✅ 成功: ${successful} 項</p>`;
            html += `<p>❌ 失敗: ${failed} 項</p>`;
            html += `<h4>詳細結果:</h4><ul>`;
            
            testResults.forEach(result => {
                const icon = result.status === '成功' ? '✅' : '❌';
                html += `<li>${icon} ${result.test}: ${result.status}`;
                if (result.error) {
                    html += ` (${result.error})`;
                }
                html += `</li>`;
            });
            
            html += `</ul>`;
            summaryDiv.innerHTML = html;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTestSummary();
        });
    </script>
</body>
</html>