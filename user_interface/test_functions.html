<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª åŠŸèƒ½æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.success {
            background: #27ae60;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª é†«é™¢ç®¡ç†ç³»çµ±åŠŸèƒ½æ¸¬è©¦</h1>
        <p>é€™å€‹é é¢ç”¨æ–¼æ¸¬è©¦æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œã€‚</p>

        <!-- æ¸¬è©¦æ–°å¢è—¥ç‰© -->
        <div class="test-section">
            <h3>ğŸ’Š æ¸¬è©¦æ–°å¢è—¥ç‰©ï¼ˆçµ±ä¸€è¡¨å–®ï¼‰</h3>
            <div class="form-group">
                <label>è—¥ç‰©åç¨±:</label>
                <input type="text" id="testMedicineName" placeholder="ä¾‹ï¼šæ¸¬è©¦è—¥ç‰©" value="åŠŸèƒ½æ¸¬è©¦è—¥ç‰©">
            </div>
            <div class="form-group">
                <label>æ•¸é‡:</label>
                <input type="number" id="testMedicineAmount" placeholder="100" value="100">
            </div>
            <div class="form-group">
                <label>å„²å­˜ä½ç½®:</label>
                <input type="text" id="testMedicinePosition" placeholder="ä¾‹ï¼š1-1" value="T-1">
            </div>
            <div class="form-group">
                <label>AIæç¤ºè©:</label>
                <textarea id="testMedicinePrompt" placeholder="AIæç¤ºè©">é€™æ˜¯ä¸€å€‹åŠŸèƒ½æ¸¬è©¦ç”¨çš„è—¥ç‰©</textarea>
            </div>
            <div class="form-group">
                <label>è—¥ç‰©æè¿°:</label>
                <textarea id="testMedicineDescription" placeholder="è—¥ç‰©æè¿°">è©³ç´°çš„åŠŸèƒ½æ¸¬è©¦æè¿°</textarea>
            </div>
            <button class="btn" onclick="testAddMedicine()">ğŸ§ª æ¸¬è©¦æ–°å¢è—¥ç‰©</button>
            <div id="addMedicineResult" class="result" style="display:none;"></div>
        </div>

        <!-- æ¸¬è©¦é–‹ç«‹è™•æ–¹ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦é–‹ç«‹è™•æ–¹ç±¤</h3>
            <div class="form-group">
                <label>ç—…æ‚£å§“å:</label>
                <input type="text" id="testPatientName" placeholder="ä¾‹ï¼šæ¸¬è©¦ç—…äºº" value="åŠŸèƒ½æ¸¬è©¦ç—…äºº">
            </div>
            <div class="form-group">
                <label>èº«ä»½è­‰è™Ÿ:</label>
                <input type="text" id="testPatientId" placeholder="A123456789" value="T123456789">
            </div>
            <div class="form-group">
                <label>è—¥ç‰©åç¨±:</label>
                <input type="text" id="testPrescMedicine" placeholder="å¾ä¸Šé¢æ–°å¢çš„è—¥ç‰©é¸æ“‡" value="åŠŸèƒ½æ¸¬è©¦è—¥ç‰©">
            </div>
            <div class="form-group">
                <label>å€‹æ•¸:</label>
                <input type="number" id="testPrescQuantity" placeholder="30" value="30">
            </div>
            <div class="form-group">
                <label>å¤©æ•¸:</label>
                <input type="number" id="testPrescDays" placeholder="7" value="7">
            </div>
            <div class="form-group">
                <label>å‚™è¨»:</label>
                <input type="text" id="testPrescNotes" placeholder="é£¯å¾Œæœç”¨" value="æ¸¬è©¦å‚™è¨»">
            </div>
            <button class="btn" onclick="testCreatePrescription()">ğŸ§ª æ¸¬è©¦é–‹ç«‹è™•æ–¹</button>
            <div id="createPrescResult" class="result" style="display:none;"></div>
        </div>

        <!-- æ¸¬è©¦æŸ¥è©¢åŠŸèƒ½ -->
        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦æŸ¥è©¢åŠŸèƒ½</h3>
            <button class="btn" onclick="testGetMedicines()">ğŸ§ª æ¸¬è©¦è—¥ç‰©æŸ¥è©¢</button>
            <button class="btn" onclick="testGetPrescriptions()">ğŸ§ª æ¸¬è©¦è™•æ–¹ç±¤æŸ¥è©¢</button>
            <div id="queryResult" class="result" style="display:none;"></div>
        </div>

        <!-- æ¸¬è©¦é é¢é€£çµ -->
        <div class="test-section">
            <h3>ğŸ”— é é¢å°èˆªæ¸¬è©¦</h3>
            <p>é»æ“Šä»¥ä¸‹æŒ‰éˆ•æ¸¬è©¦å„å€‹é é¢æ˜¯å¦æ­£å¸¸è¼‰å…¥ï¼š</p>
            <button class="btn" onclick="window.open('/doctor.html', '_blank')">ğŸ‘¨â€âš•ï¸ é†«ç”Ÿå·¥ä½œå°</button>
            <button class="btn" onclick="window.open('/integrated_medicine_management.html', '_blank')">ğŸ”§ æ•´åˆç®¡ç†</button>
            <button class="btn" onclick="window.open('/Prescription.html', '_blank')">ğŸ“‹ è™•æ–¹ç±¤ç®¡ç†</button>
            <button class="btn" onclick="window.open('/Medicine.html', '_blank')">ğŸ’Š è—¥ç‰©ç®¡ç†</button>
        </div>

        <!-- çµæœæ‘˜è¦ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦çµæœæ‘˜è¦</h3>
            <div id="testSummary"></div>
            <button class="btn success" onclick="runAllTests()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        </div>
    </div>

    <script>
        let testResults = [];

        async function testAddMedicine() {
            const resultDiv = document.getElementById('addMedicineResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ æ¸¬è©¦ä¸­...';

            try {
                const testData = {
                    basic_data: {
                        name: document.getElementById('testMedicineName').value,
                        amount: parseInt(document.getElementById('testMedicineAmount').value),
                        position: document.getElementById('testMedicinePosition').value,
                        prompt: document.getElementById('testMedicinePrompt').value
                    },
                    detailed_data: {
                        description: document.getElementById('testMedicineDescription').value
                    }
                };

                const response = await fetch('/api/medicine/unified', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… æ–°å¢è—¥ç‰©æˆåŠŸï¼<br>è—¥ç‰©åç¨±: ${result.basic_medicine.name}<br>AIæç¤º: ${result.basic_medicine.prompt}`;
                    testResults.push({test: 'æ–°å¢è—¥ç‰©', status: 'æˆåŠŸ'});
                } else {
                    throw new Error(result.detail || 'æ–°å¢å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                testResults.push({test: 'æ–°å¢è—¥ç‰©', status: 'å¤±æ•—', error: error.message});
            }
        }

        async function testCreatePrescription() {
            const resultDiv = document.getElementById('createPrescResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ æ¸¬è©¦ä¸­...';

            try {
                const testData = {
                    patient_name: document.getElementById('testPatientName').value,
                    patient_id: 'P' + Date.now(),
                    doctor_name: 'æ¸¬è©¦é†«ç”Ÿ',
                    medicines: [[
                        document.getElementById('testPrescMedicine').value,
                        document.getElementById('testPrescQuantity').value,
                        document.getElementById('testPrescDays').value,
                        document.getElementById('testPrescNotes').value
                    ]]
                };

                const response = await fetch('/api/prescription/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… é–‹ç«‹è™•æ–¹æˆåŠŸï¼<br>ç—…äºº: ${result.prescription.patient_name}<br>è—¥ç‰©æ•¸é‡: ${result.prescription.medicines.length}ç¨®`;
                    testResults.push({test: 'é–‹ç«‹è™•æ–¹', status: 'æˆåŠŸ'});
                } else {
                    throw new Error(result.detail || 'é–‹ç«‹å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                testResults.push({test: 'é–‹ç«‹è™•æ–¹', status: 'å¤±æ•—', error: error.message});
            }
        }

        async function testGetMedicines() {
            const resultDiv = document.getElementById('queryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ æŸ¥è©¢è—¥ç‰©ä¸­...';

            try {
                const response = await fetch('/api/medicine/basic');
                const result = await response.json();

                if (response.ok) {
                    const medicines = result.medicines || [];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… è—¥ç‰©æŸ¥è©¢æˆåŠŸï¼<br>å…±æ‰¾åˆ° ${medicines.length} ç¨®è—¥ç‰©<br>æœ€æ–°è—¥ç‰©: ${medicines[medicines.length - 1]?.name || 'ç„¡'}`;
                    testResults.push({test: 'è—¥ç‰©æŸ¥è©¢', status: 'æˆåŠŸ'});
                } else {
                    throw new Error('æŸ¥è©¢å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`;
                testResults.push({test: 'è—¥ç‰©æŸ¥è©¢', status: 'å¤±æ•—', error: error.message});
            }
        }

        async function testGetPrescriptions() {
            const resultDiv = document.getElementById('queryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ æŸ¥è©¢è™•æ–¹ç±¤ä¸­...';

            try {
                const response = await fetch('/api/prescription/');
                const result = await response.json();

                if (response.ok) {
                    const prescriptions = result.prescriptions || [];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… è™•æ–¹ç±¤æŸ¥è©¢æˆåŠŸï¼<br>å…±æ‰¾åˆ° ${prescriptions.length} å¼µè™•æ–¹ç±¤`;
                    testResults.push({test: 'è™•æ–¹ç±¤æŸ¥è©¢', status: 'æˆåŠŸ'});
                } else {
                    throw new Error('æŸ¥è©¢å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`;
                testResults.push({test: 'è™•æ–¹ç±¤æŸ¥è©¢', status: 'å¤±æ•—', error: error.message});
            }
        }

        async function runAllTests() {
            testResults = [];
            updateTestSummary();
            
            await testAddMedicine();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCreatePrescription();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGetMedicines();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGetPrescriptions();
            
            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            if (testResults.length === 0) {
                summaryDiv.innerHTML = 'ğŸ“‹ å°šæœªåŸ·è¡Œæ¸¬è©¦';
                return;
            }

            const successful = testResults.filter(r => r.status === 'æˆåŠŸ').length;
            const failed = testResults.filter(r => r.status === 'å¤±æ•—').length;
            
            let html = `<h4>æ¸¬è©¦çµæœçµ±è¨ˆ:</h4>`;
            html += `<p>âœ… æˆåŠŸ: ${successful} é …</p>`;
            html += `<p>âŒ å¤±æ•—: ${failed} é …</p>`;
            html += `<h4>è©³ç´°çµæœ:</h4><ul>`;
            
            testResults.forEach(result => {
                const icon = result.status === 'æˆåŠŸ' ? 'âœ…' : 'âŒ';
                html += `<li>${icon} ${result.test}: ${result.status}`;
                if (result.error) {
                    html += ` (${result.error})`;
                }
                html += `</li>`;
            });
            
            html += `</ul>`;
            summaryDiv.innerHTML = html;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTestSummary();
        });
    </script>
</body>
</html>