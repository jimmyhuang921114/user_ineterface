<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª ç³»çµ±åŠŸèƒ½æ¸¬è©¦ - é†«é™¢ç®¡ç†ç³»çµ±</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #3498db;
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
        }
        
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .test-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .test-btn.success {
            background: #27ae60;
        }
        
        .test-btn.error {
            background: #e74c3c;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        
        .result.error {
            background: #ffeaa7;
            border-left: 4px solid #e74c3c;
        }
        
        .result.info {
            background: #e3f2fd;
            border-left: 4px solid #3498db;
        }
        
        .nav-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .nav-link {
            display: block;
            background: #34495e;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #2c3e50;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç³»çµ±åŠŸèƒ½å…¨é¢æ¸¬è©¦</h1>
            <p>æ¸¬è©¦æ‰€æœ‰ä¿®å¾©çš„åŠŸèƒ½ï¼Œç¢ºä¿ç³»çµ±æ­£å¸¸é‹ä½œ</p>
            <div id="generalStatus"></div>
        </div>

        <!-- åŸºæœ¬APIæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ”Œ åŸºæœ¬APIé€£ç·šæ¸¬è©¦</h3>
            <button class="test-btn" onclick="testBasicAPI()">æ¸¬è©¦åŸºæœ¬è—¥ç‰©API</button>
            <button class="test-btn" onclick="testDetailedAPI()">æ¸¬è©¦è©³ç´°è—¥ç‰©API</button>
            <button class="test-btn" onclick="testPrescriptionAPI()">æ¸¬è©¦è™•æ–¹ç±¤API</button>
            <div id="basicAPIResult" class="result" style="display:none;"></div>
        </div>

        <!-- åº«å­˜èª¿æ•´æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ“¦ åº«å­˜èª¿æ•´åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="test-btn" onclick="testStockAdd()">æ¸¬è©¦å¢åŠ åº«å­˜</button>
            <button class="test-btn" onclick="testStockSubtract()">æ¸¬è©¦æ¸›å°‘åº«å­˜</button>
            <button class="test-btn" onclick="testInvalidStock()">æ¸¬è©¦ç„¡æ•ˆæ“ä½œ</button>
            <div id="stockResult" class="result" style="display:none;"></div>
        </div>

        <!-- è™•æ–¹ç±¤å‰µå»ºæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ¥ è™•æ–¹ç±¤å‰µå»ºæ¸¬è©¦</h3>
            <button class="test-btn" onclick="testPrescriptionCreate()">å‰µå»ºæ¸¬è©¦è™•æ–¹ç±¤</button>
            <button class="test-btn" onclick="testPrescriptionValidation()">æ¸¬è©¦æ•¸æ“šé©—è­‰</button>
            <div id="prescriptionResult" class="result" style="display:none;"></div>
        </div>

        <!-- ROS2ç‹€æ…‹æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ¤– ROS2ç‹€æ…‹æ›´æ–°æ¸¬è©¦</h3>
            <button class="test-btn" onclick="testROS2StatusUpdate()">æ¸¬è©¦ç‹€æ…‹æ›´æ–°</button>
            <button class="test-btn" onclick="testROS2StatusQuery()">æŸ¥è©¢ç‹€æ…‹è¨˜éŒ„</button>
            <div id="ros2Result" class="result" style="display:none;"></div>
        </div>

        <!-- AIæç¤ºè©æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ¤– AIæç¤ºè©åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="test-btn" onclick="testPromptFeature()">æ¸¬è©¦æç¤ºè©ä¿å­˜</button>
            <button class="test-btn" onclick="testPromptQuery()">æŸ¥è©¢æç¤ºè©</button>
            <div id="promptResult" class="result" style="display:none;"></div>
        </div>

        <!-- å°èˆªéˆæ¥ -->
        <div class="nav-links">
            <a href="/html/doctor.html" class="nav-link">ğŸ‘¨â€âš•ï¸ é†«ç”Ÿå·¥ä½œå°</a>
            <a href="/html/integrated_medicine_management.html" class="nav-link">ğŸ¥ è—¥ç‰©ç®¡ç†</a>
            <a href="/html/Prescription.html" class="nav-link">ğŸ“‹ è™•æ–¹æŸ¥è©¢</a>
            <a href="/html/Medicine.html" class="nav-link">ğŸ’Š è—¥ç‰©æŸ¥è©¢</a>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, content, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        // åŸºæœ¬APIæ¸¬è©¦
        async function testBasicAPI() {
            try {
                const response = await fetch(`${API_BASE}/medicine/basic`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('basicAPIResult', 
                        `âœ… åŸºæœ¬è—¥ç‰©APIæ­£å¸¸\nå…±æœ‰ ${data.medicines.length} ç¨®è—¥ç‰©\nç¬¬ä¸€ç¨®è—¥ç‰©: ${data.medicines[0]?.name || 'ç„¡'}`, 
                        'success');
                } else {
                    throw new Error(`APIéŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                showResult('basicAPIResult', `âŒ åŸºæœ¬è—¥ç‰©APIéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testDetailedAPI() {
            try {
                const response = await fetch(`${API_BASE}/medicine/detailed`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('basicAPIResult', 
                        `âœ… è©³ç´°è—¥ç‰©APIæ­£å¸¸\nå…±æœ‰ ${data.medicines.length} ç¨®è©³ç´°è—¥ç‰©è³‡æ–™`, 
                        'success');
                } else {
                    throw new Error(`APIéŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                showResult('basicAPIResult', `âŒ è©³ç´°è—¥ç‰©APIéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testPrescriptionAPI() {
            try {
                const response = await fetch(`${API_BASE}/prescription/`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('basicAPIResult', 
                        `âœ… è™•æ–¹ç±¤APIæ­£å¸¸\nå…±æœ‰ ${data.prescriptions.length} å¼µè™•æ–¹ç±¤`, 
                        'success');
                } else {
                    throw new Error(`APIéŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                showResult('basicAPIResult', `âŒ è™•æ–¹ç±¤APIéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // åº«å­˜èª¿æ•´æ¸¬è©¦
        async function testStockAdd() {
            try {
                // å…ˆç²å–ç¬¬ä¸€å€‹è—¥ç‰©
                const medicinesResponse = await fetch(`${API_BASE}/medicine/basic`);
                const medicinesData = await medicinesResponse.json();
                
                if (!medicinesData.medicines.length) {
                    throw new Error('æ²’æœ‰å¯ç”¨çš„è—¥ç‰©é€²è¡Œæ¸¬è©¦');
                }
                
                const testMedicine = medicinesData.medicines[0];
                const originalAmount = testMedicine.amount;
                
                const response = await fetch(`${API_BASE}/medicine/adjust-stock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medicine_name: testMedicine.name,
                        action: 'add',
                        amount: 5
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('stockResult', 
                        `âœ… åº«å­˜å¢åŠ æ¸¬è©¦æˆåŠŸ\nè—¥ç‰©: ${testMedicine.name}\nåŸæ•¸é‡: ${originalAmount}\næ–°æ•¸é‡: ${result.new_amount}\nå¢åŠ : 5`, 
                        'success');
                } else {
                    throw new Error(result.detail || 'åº«å­˜èª¿æ•´å¤±æ•—');
                }
            } catch (error) {
                showResult('stockResult', `âŒ åº«å­˜å¢åŠ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testStockSubtract() {
            try {
                const medicinesResponse = await fetch(`${API_BASE}/medicine/basic`);
                const medicinesData = await medicinesResponse.json();
                
                if (!medicinesData.medicines.length) {
                    throw new Error('æ²’æœ‰å¯ç”¨çš„è—¥ç‰©é€²è¡Œæ¸¬è©¦');
                }
                
                const testMedicine = medicinesData.medicines[0];
                const originalAmount = testMedicine.amount;
                
                const response = await fetch(`${API_BASE}/medicine/adjust-stock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medicine_name: testMedicine.name,
                        action: 'subtract',
                        amount: 2
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('stockResult', 
                        `âœ… åº«å­˜æ¸›å°‘æ¸¬è©¦æˆåŠŸ\nè—¥ç‰©: ${testMedicine.name}\nåŸæ•¸é‡: ${originalAmount}\næ–°æ•¸é‡: ${result.new_amount}\næ¸›å°‘: 2`, 
                        'success');
                } else {
                    throw new Error(result.detail || 'åº«å­˜èª¿æ•´å¤±æ•—');
                }
            } catch (error) {
                showResult('stockResult', `âŒ åº«å­˜æ¸›å°‘æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testInvalidStock() {
            try {
                const response = await fetch(`${API_BASE}/medicine/adjust-stock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        medicine_name: 'ä¸å­˜åœ¨çš„è—¥ç‰©',
                        action: 'add',
                        amount: 5
                    })
                });
                
                const result = await response.json();
                
                if (response.status === 404) {
                    showResult('stockResult', 
                        `âœ… ç„¡æ•ˆæ“ä½œæ¸¬è©¦æˆåŠŸ\næ­£ç¢ºè­˜åˆ¥ä¸å­˜åœ¨çš„è—¥ç‰©\néŒ¯èª¤è¨Šæ¯: ${result.detail}`, 
                        'success');
                } else {
                    throw new Error('æ‡‰è©²è¿”å›404éŒ¯èª¤');
                }
            } catch (error) {
                showResult('stockResult', `âŒ ç„¡æ•ˆæ“ä½œæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è™•æ–¹ç±¤æ¸¬è©¦
        async function testPrescriptionCreate() {
            try {
                const response = await fetch(`${API_BASE}/prescription/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_name: 'æ¸¬è©¦ç—…äºº_' + Date.now(),
                        patient_id: 'P' + Date.now(),
                        doctor_name: 'æ¸¬è©¦é†«ç”Ÿ',
                        medicines: [['æ¸¬è©¦è—¥ç‰©2', '10', '5', 'æ¸¬è©¦ç”¨è—¥']]
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('prescriptionResult', 
                        `âœ… è™•æ–¹ç±¤å‰µå»ºæˆåŠŸ\nç—…äºº: ${result.prescription.patient_name}\nè—¥ç‰©æ•¸é‡: ${result.prescription.medicines.length}`, 
                        'success');
                } else {
                    throw new Error(result.detail || 'è™•æ–¹ç±¤å‰µå»ºå¤±æ•—');
                }
            } catch (error) {
                showResult('prescriptionResult', `âŒ è™•æ–¹ç±¤å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testPrescriptionValidation() {
            try {
                const response = await fetch(`${API_BASE}/prescription/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_name: '',
                        patient_id: '',
                        doctor_name: '',
                        medicines: []
                    })
                });
                
                const result = await response.json();
                
                if (response.status === 422) {
                    showResult('prescriptionResult', 
                        `âœ… æ•¸æ“šé©—è­‰æ¸¬è©¦æˆåŠŸ\næ­£ç¢ºè­˜åˆ¥ç„¡æ•ˆæ•¸æ“š\néŒ¯èª¤è¨Šæ¯: ${result.detail}`, 
                        'success');
                } else {
                    throw new Error('æ‡‰è©²è¿”å›é©—è­‰éŒ¯èª¤');
                }
            } catch (error) {
                showResult('prescriptionResult', `âŒ æ•¸æ“šé©—è­‰æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ROS2ç‹€æ…‹æ¸¬è©¦
        async function testROS2StatusUpdate() {
            try {
                const response = await fetch(`${API_BASE}/prescription/status-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: 'TEST_' + Date.now(),
                        status: 'completed',
                        message: 'æ¸¬è©¦ç‹€æ…‹æ›´æ–°',
                        patient_name: 'æ¸¬è©¦ç—…äºº',
                        patient_id: 'P123456',
                        medicine_count: 1,
                        medicines: [{ name: 'æ¸¬è©¦è—¥ç‰©', quantity: 10, status: 'completed' }]
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showResult('ros2Result', 
                        `âœ… ROS2ç‹€æ…‹æ›´æ–°æˆåŠŸ\nè¨‚å–®ID: ${result.order_id}\nç‹€æ…‹: ${result.status}`, 
                        'success');
                } else {
                    throw new Error(result.detail || 'ROS2ç‹€æ…‹æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                showResult('ros2Result', `âŒ ROS2ç‹€æ…‹æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testROS2StatusQuery() {
            try {
                // é€™è£¡å¯ä»¥æŸ¥è©¢ç‹€æ…‹è¨˜éŒ„ï¼Œä½†ç›®å‰APIæ²’æœ‰æä¾›æŸ¥è©¢ç«¯é»
                showResult('ros2Result', 
                    `â„¹ï¸ ROS2ç‹€æ…‹æŸ¥è©¢åŠŸèƒ½\nç›®å‰ç³»çµ±æ”¯æ´ç‹€æ…‹æ›´æ–°\nå¦‚éœ€æŸ¥è©¢åŠŸèƒ½ï¼Œå¯ä»¥æ“´å±•APIç«¯é»`, 
                    'info');
            } catch (error) {
                showResult('ros2Result', `âŒ ROS2ç‹€æ…‹æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // AIæç¤ºè©æ¸¬è©¦
        async function testPromptFeature() {
            try {
                const response = await fetch(`${API_BASE}/medicine/basic`);
                const data = await response.json();
                
                if (response.ok) {
                    const medicinesWithPrompt = data.medicines.filter(m => m.prompt && m.prompt.trim());
                    showResult('promptResult', 
                        `âœ… AIæç¤ºè©åŠŸèƒ½æ­£å¸¸\næœ‰æç¤ºè©çš„è—¥ç‰©: ${medicinesWithPrompt.length} ç¨®\nç¯„ä¾‹: ${medicinesWithPrompt[0]?.prompt || 'ç„¡'}`, 
                        'success');
                } else {
                    throw new Error(`APIéŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                showResult('promptResult', `âŒ AIæç¤ºè©æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testPromptQuery() {
            try {
                const response = await fetch(`${API_BASE}/medicine/basic`);
                const data = await response.json();
                
                if (response.ok) {
                    const promptStats = data.medicines.reduce((acc, medicine) => {
                        if (medicine.prompt && medicine.prompt.trim()) {
                            acc.withPrompt++;
                        } else {
                            acc.withoutPrompt++;
                        }
                        return acc;
                    }, { withPrompt: 0, withoutPrompt: 0 });
                    
                    showResult('promptResult', 
                        `âœ… æç¤ºè©çµ±è¨ˆæŸ¥è©¢æˆåŠŸ\næœ‰æç¤ºè©: ${promptStats.withPrompt} ç¨®\nç„¡æç¤ºè©: ${promptStats.withoutPrompt} ç¨®\nç¸½è—¥ç‰©: ${data.medicines.length} ç¨®`, 
                        'success');
                } else {
                    throw new Error(`APIéŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                showResult('promptResult', `âŒ æç¤ºè©æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è‡ªå‹•é‹è¡ŒåŸºæœ¬æ¸¬è©¦
        window.addEventListener('load', function() {
            setTimeout(testBasicAPI, 1000);
        });
    </script>
</body>
</html>