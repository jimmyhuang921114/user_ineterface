<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™•æ–¹ç®¡ç†ç³»çµ± - é†«é™¢ç®¡ç†ç³»çµ±</title>
    
    <!-- çµ±ä¸€é¢¨æ ¼ -->
    <link rel="stylesheet" href="../css/unified_style.css">
    
    <!-- Handsontable (ç”¨æ–¼è™•æ–¹è©³æƒ…é¡¯ç¤º) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>é†«é™¢ç®¡ç†ç³»çµ±</h2>
        <button onclick="location.href='doctor.html'">é†«ç”Ÿå·¥ä½œå°</button>
        <button onclick="location.href='Medicine.html'">è—¥ç‰©åº«å­˜ç®¡ç†</button>
        <button onclick="location.href='Prescription.html'" class="active">è™•æ–¹ç®¡ç†ç³»çµ±</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>è™•æ–¹ç®¡ç†ç³»çµ±</h1>
            <p>æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰é†«å¸«é–‹ç«‹çš„è™•æ–¹ - å³æ™‚æ›´æ–°è™•æ–¹ç‹€æ…‹</p>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>ğŸ“Š è™•æ–¹çµ±è¨ˆ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="totalCount">0</div>
                        <div style="color: #7f8c8d;">ç¸½è™•æ–¹æ•¸</div>
                    </div>
                    <div style="padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="pendingCount">0</div>
                        <div style="color: #7f8c8d;">å¾…è™•ç†</div>
                    </div>
                    <div style="padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9b59b6;" id="processingCount">0</div>
                        <div style="color: #7f8c8d;">è™•ç†ä¸­</div>
                    </div>
                    <div style="padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="completedCount">0</div>
                        <div style="color: #7f8c8d;">å·²å®Œæˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¯©é¸å’Œæ“ä½œå€ -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label for="statusFilter">ğŸ” ç‹€æ…‹ç¯©é¸</label>
                        <select id="statusFilter" onchange="filterPrescriptions()" style="width: 150px;">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="pending">å¾…è™•ç†</option>
                            <option value="processing">è™•ç†ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </div>

                    <button class="btn btn-info" onclick="loadPrescriptions()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-success" onclick="exportPrescriptions()">ğŸ“Š åŒ¯å‡ºè³‡æ–™</button>
                </div>
            </div>
        </div>

        <!-- è™•æ–¹åˆ—è¡¨ -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>ğŸ“‹ è™•æ–¹åˆ—è¡¨</h3>
                <div class="table-container">
                    <div id="prescriptionTable" style="width: 100%; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">è™•æ–¹ç·¨è™Ÿ</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">ç—…æ‚£å§“å</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">ä¸»æ²»é†«å¸«</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">è¨ºæ–·çµæœ</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">è—¥ç‰©æ•¸é‡</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">è™•æ–¹ç‹€æ…‹</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">é–‹ç«‹æ—¥æœŸ</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="prescriptionTableBody">
                                <tr>
                                    <td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">
                                        <div>ğŸ“­ æš«ç„¡è™•æ–¹è³‡æ–™</div>
                                        <div style="margin-top: 10px; font-size: 14px;">è«‹é†«å¸«å…ˆåœ¨é†«ç”Ÿå·¥ä½œå°é–‹ç«‹è™•æ–¹</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- è™•æ–¹è©³æƒ…æ¨¡æ…‹æ¡† -->
        <div id="prescriptionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h3 id="modalTitle">è™•æ–¹è©³æƒ…</h3>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <div id="modalContent"></div>
                <div style="margin-top: 25px; text-align: right;">
                    <button class="btn btn-danger" onclick="closeModal()">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const API_BASE = 'http://localhost:8000';
        let allPrescriptions = [];
        let filteredPrescriptions = [];

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPrescriptions();
        });

        // è¼‰å…¥æ‰€æœ‰è™•æ–¹
        async function loadPrescriptions() {
            try {
                const response = await fetch(`${API_BASE}/api/prescription/`);
                if (response.ok) {
                    allPrescriptions = await response.json();
                    filteredPrescriptions = [...allPrescriptions];
                    updateStatistics();
                    renderPrescriptions();
                    console.log(`âœ… è¼‰å…¥äº† ${allPrescriptions.length} å€‹è™•æ–¹`);
                } else {
                    showMessage('è¼‰å…¥è™•æ–¹å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥è™•æ–¹éŒ¯èª¤:', error);
                showMessage('é€£æ¥APIå¤±æ•—', 'error');
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const total = allPrescriptions.length;
            const pending = allPrescriptions.filter(p => p.status === 'pending').length;
            const processing = allPrescriptions.filter(p => p.status === 'processing').length;
            const completed = allPrescriptions.filter(p => p.status === 'completed').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('processingCount').textContent = processing;
            document.getElementById('completedCount').textContent = completed;
        }

        // ç¯©é¸è™•æ–¹
        function filterPrescriptions() {
            const statusFilter = document.getElementById('statusFilter').value;

            filteredPrescriptions = allPrescriptions.filter(prescription => {
                const statusMatch = !statusFilter || prescription.status === statusFilter;
                return statusMatch;
            });

            renderPrescriptions();
        }

        // æ¸²æŸ“è™•æ–¹åˆ—è¡¨
        function renderPrescriptions() {
            const tbody = document.getElementById('prescriptionTableBody');
            
            if (filteredPrescriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">
                            <div>ğŸ“­ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è™•æ–¹</div>
                            <div style="margin-top: 10px; font-size: 14px;">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–è«‹é†«å¸«é–‹ç«‹æ–°è™•æ–¹</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredPrescriptions.map(prescription => {
                const statusText = getStatusText(prescription.status);
                const statusColor = getStatusColor(prescription.status);
                
                return `
                    <tr style="cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600; color: #3498db;">#${prescription.id}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${prescription.patient_name}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${prescription.doctor_name}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${prescription.diagnosis || 'ç„¡è¨ºæ–·è³‡è¨Š'}">${prescription.diagnosis || 'ç„¡è¨ºæ–·è³‡è¨Š'}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                            <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                ${prescription.medicines.length} ç¨®
                            </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">
                            <span style="background: ${statusColor}; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 12px;">
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">${formatDate(prescription.prescription_date)}</td>
                        <td style="padding: 12px; border: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-info" style="padding: 6px 12px; font-size: 12px;" onclick="showPrescriptionDetail(${prescription.id})">ğŸ“‹ è©³æƒ…</button>
                                <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="updateStatus(${prescription.id})">ğŸ“ ç‹€æ…‹</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ç²å–ç‹€æ…‹æ–‡å­—
        function getStatusText(status) {
            const statusMap = {
                'pending': 'â³ å¾…è™•ç†',
                'processing': 'ğŸ”„ è™•ç†ä¸­',
                'completed': 'âœ… å·²å®Œæˆ',
                'cancelled': 'âŒ å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // ç²å–ç‹€æ…‹é¡è‰²
        function getStatusColor(status) {
            const colorMap = {
                'pending': 'rgba(243, 156, 18, 0.2); color: #f39c12',
                'processing': 'rgba(155, 89, 182, 0.2); color: #9b59b6',
                'completed': 'rgba(39, 174, 96, 0.2); color: #27ae60',
                'cancelled': 'rgba(231, 76, 60, 0.2); color: #e74c3c'
            };
            return colorMap[status] || 'rgba(127, 140, 141, 0.2); color: #7f8c8d';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'ç„¡æ—¥æœŸ';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        }

        // é¡¯ç¤ºè™•æ–¹è©³æƒ…
        async function showPrescriptionDetail(prescriptionId) {
            try {
                const response = await fetch(`${API_BASE}/api/prescription/${prescriptionId}`);
                if (response.ok) {
                    const data = await response.json();
                    const prescription = data.prescription;
                    
                    document.getElementById('modalTitle').textContent = `è™•æ–¹è©³æƒ… - #${prescription.id}`;
                    document.getElementById('modalContent').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            <div>
                                <h4>ğŸ‘¤ ç—…æ‚£è³‡è¨Š</h4>
                                <p><strong>å§“å:</strong> ${prescription.patient_name}</p>
                                <p><strong>è¨ºæ–·:</strong> ${prescription.diagnosis || 'ç„¡è¨ºæ–·è³‡è¨Š'}</p>
                            </div>
                            <div>
                                <h4>ğŸ‘¨â€âš•ï¸ é†«å¸«è³‡è¨Š</h4>
                                <p><strong>ä¸»æ²»é†«å¸«:</strong> ${prescription.doctor_name}</p>
                                <p><strong>é–‹ç«‹æ—¥æœŸ:</strong> ${formatDate(prescription.prescription_date)}</p>
                            </div>
                            <div>
                                <h4>ğŸ“Š è™•æ–¹ç‹€æ…‹</h4>
                                <p><strong>ç•¶å‰ç‹€æ…‹:</strong> ${getStatusText(prescription.status)}</p>
                                <p><strong>å»ºç«‹æ™‚é–“:</strong> ${formatDate(prescription.created_time)}</p>
                            </div>
                        </div>
                        
                        <h4>ğŸ’Š è™•æ–¹è—¥ç‰©æ¸…å–®</h4>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 10px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #e9ecef;">
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">è—¥ç‰©åç¨±</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">åŠ‘é‡</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ä½¿ç”¨é »ç‡</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ä½¿ç”¨å¤©æ•¸</th>
                                        <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ç‰¹æ®ŠæŒ‡ç¤º</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prescription.medicines.map(med => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">${med.medicine_name}</td>
                                            <td style="padding: 10px; border: 1px solid #dee2e6;">${med.dosage}</td>
                                            <td style="padding: 10px; border: 1px solid #dee2e6;">${med.frequency}</td>
                                            <td style="padding: 10px; border: 1px solid #dee2e6;">${med.duration}</td>
                                            <td style="padding: 10px; border: 1px solid #dee2e6;">${med.instructions || 'ç„¡ç‰¹æ®ŠæŒ‡ç¤º'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('prescriptionModal').style.display = 'block';
                } else {
                    showMessage('è¼‰å…¥è™•æ–¹è©³æƒ…å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥è™•æ–¹è©³æƒ…éŒ¯èª¤:', error);
                showMessage('é€£æ¥APIå¤±æ•—', 'error');
            }
        }

        // æ›´æ–°è™•æ–¹ç‹€æ…‹
        async function updateStatus(prescriptionId) {
            const newStatus = prompt('è«‹é¸æ“‡æ–°ç‹€æ…‹:\n- pending (å¾…è™•ç†)\n- processing (è™•ç†ä¸­)\n- completed (å·²å®Œæˆ)\n- cancelled (å·²å–æ¶ˆ)\n\nè«‹è¼¸å…¥:', 'processing');
            
            if (!newStatus) return;
            
            const validStatuses = ['pending', 'processing', 'completed', 'cancelled'];
            if (!validStatuses.includes(newStatus)) {
                alert('ç„¡æ•ˆçš„ç‹€æ…‹ï¼Œè«‹è¼¸å…¥: pending, processing, completed, æˆ– cancelled');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/prescription/${prescriptionId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        updated_by: 'è—¥å¸«',
                        notes: `ç‹€æ…‹æ›´æ–°ç‚º: ${getStatusText(newStatus)}`
                    })
                });

                if (response.ok) {
                    showMessage('è™•æ–¹ç‹€æ…‹æ›´æ–°æˆåŠŸï¼', 'success');
                    loadPrescriptions(); // é‡æ–°è¼‰å…¥è³‡æ–™
                } else {
                    const error = await response.json();
                    showMessage(`æ›´æ–°å¤±æ•—: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°ç‹€æ…‹éŒ¯èª¤:', error);
                showMessage('é€£æ¥APIå¤±æ•—', 'error');
            }
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('prescriptionModal').style.display = 'none';
        }

        // åŒ¯å‡ºè™•æ–¹è³‡æ–™
        function exportPrescriptions() {
            if (filteredPrescriptions.length === 0) {
                alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
                return;
            }

            const csvContent = generateCSV(filteredPrescriptions);
            downloadCSV(csvContent, `è™•æ–¹è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ç”ŸæˆCSVå…§å®¹
        function generateCSV(prescriptions) {
            const headers = ['è™•æ–¹ç·¨è™Ÿ', 'ç—…æ‚£å§“å', 'ä¸»æ²»é†«å¸«', 'è¨ºæ–·çµæœ', 'è™•æ–¹ç‹€æ…‹', 'é–‹ç«‹æ—¥æœŸ', 'è—¥ç‰©æ¸…å–®'];
            const csvRows = [headers.join(',')];

            prescriptions.forEach(prescription => {
                const medicines = prescription.medicines.map(med => 
                    `${med.medicine_name}(${med.dosage},${med.frequency},${med.duration})`
                ).join(';');
                
                const row = [
                    prescription.id,
                    `"${prescription.patient_name}"`,
                    `"${prescription.doctor_name}"`,
                    `"${prescription.diagnosis || ''}"`,
                    getStatusText(prescription.status),
                    prescription.prescription_date,
                    `"${medicines}"`
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // ä¸‹è¼‰CSVæ–‡ä»¶
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            const alertColor = type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db';
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 3000;
                background: ${alertColor}; color: white; padding: 15px 20px;
                border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500; max-width: 300px;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }
    </script>
</body>
</html> 