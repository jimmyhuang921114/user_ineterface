<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ å¯¦æ™‚ç›£æ§ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title .emoji {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .medicine-search {
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .medicine-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .medicine-info h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .medicine-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-out;
        }

        .notification.new-order {
            border-left-color: #ffc107;
        }

        .notification.status-update {
            border-left-color: #28a745;
        }

        .notification.medicine-update {
            border-left-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-time {
            font-size: 12px;
            color: #999;
            float: right;
        }

        .notification-message {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .order-controls {
            margin-top: 20px;
        }

        .status-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .status-btn.pending {
            background: #ffc107;
            color: white;
        }

        .status-btn.processing {
            background: #17a2b8;
            color: white;
        }

        .status-btn.completed {
            background: #28a745;
            color: white;
        }

        .status-btn.failed {
            background: #dc3545;
            color: white;
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        .clear-btn:hover {
            background: #5a6268;
        }

        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ å¯¦æ™‚è—¥ç‰©ç®¡ç†ç›£æ§ç³»çµ±</h1>
            <p>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">é€£æ¥ä¸­...</span>
            </p>
        </div>

        <div class="main-content">
            <!-- è—¥ç‰©æŸ¥è©¢å€åŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">ğŸ’Š</span>
                    è—¥ç‰©è³‡æ–™æŸ¥è©¢
                </div>
                
                <div class="medicine-search">
                    <input type="text" id="medicineSearch" class="search-input" 
                           placeholder="è¼¸å…¥è—¥ç‰©åç¨±æœå°‹..." />
                </div>
                
                <div id="medicineResults">
                    <div class="no-data">è«‹è¼¸å…¥è—¥ç‰©åç¨±é€²è¡Œæœå°‹</div>
                </div>
            </div>

            <!-- å¯¦æ™‚é€šçŸ¥å€åŸŸ -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">ğŸ””</span>
                    å¯¦æ™‚é€šçŸ¥
                    <button class="clear-btn" onclick="clearNotifications()" style="margin-left: auto;">æ¸…é™¤é€šçŸ¥</button>
                </div>
                
                <div id="notifications">
                    <div class="no-data">æš«ç„¡é€šçŸ¥</div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œå€åŸŸ -->
        <div class="quick-actions">
            <button class="action-btn" onclick="refreshMedicines()">ğŸ”„ é‡æ–°æ•´ç†è—¥ç‰©è³‡æ–™</button>
            <button class="action-btn" onclick="viewAllOrders()">ğŸ“¦ æŸ¥çœ‹æ‰€æœ‰è¨‚å–®</button>
            <button class="action-btn" onclick="openIntegratedForm()">â• æ–°å¢è—¥ç‰©</button>
            <button class="action-btn" onclick="testROS2Connection()">ğŸ¤– æ¸¬è©¦ROS2é€£æ¥</button>
        </div>
    </div>

    <script>
        let websocket = null;
        let notifications = [];
        let currentMedicine = null;

        // WebSocketé€£æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocketé€£æ¥æˆåŠŸ');
                updateConnectionStatus(true);
                showNotification('ç³»çµ±é€£æ¥æˆåŠŸ', 'WebSocketé€£æ¥å·²å»ºç«‹', 'success');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleRealtimeNotification(data);
                } catch (error) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±æ•—:', error);
                }
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocketé€£æ¥é—œé–‰');
                updateConnectionStatus(false);
                // è‡ªå‹•é‡é€£
                setTimeout(connectWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocketéŒ¯èª¤:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'å³æ™‚é€£ç·šä¸­';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'é€£ç·šä¸­æ–·';
            }
        }

        function handleRealtimeNotification(data) {
            let message = '';
            let type = data.type || 'info';
            
            switch (data.type) {
                case 'medicine_basic_updated':
                    message = `è—¥ç‰©åŸºæœ¬è³‡æ–™å·²æ›´æ–°: ${data.medicine.name}`;
                    type = 'medicine-update';
                    // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ­¤è—¥ç‰©ï¼Œè‡ªå‹•æ›´æ–°
                    if (currentMedicine === data.medicine.name) {
                        searchMedicine(data.medicine.name);
                    }
                    break;
                case 'medicine_detailed_updated':
                    message = `è—¥ç‰©è©³ç´°è³‡æ–™å·²æ›´æ–°: ${data.medicine.medicine_name}`;
                    type = 'medicine-update';
                    // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ­¤è—¥ç‰©ï¼Œè‡ªå‹•æ›´æ–°
                    if (currentMedicine === data.medicine.medicine_name) {
                        searchMedicine(data.medicine.medicine_name);
                    }
                    break;
                case 'new_order':
                    message = `æ”¶åˆ°æ–°è¨‚å–®: ${data.order.id}`;
                    type = 'new-order';
                    addOrderControls(data.order);
                    break;
                case 'ros2_order_request':
                    message = `ğŸ¤– ${data.message}`;
                    type = 'new-order';
                    addOrderControls(data.order);
                    break;
                case 'order_status_updated':
                    message = `è¨‚å–®ç‹€æ…‹æ›´æ–°: ${data.order_id} -> ${data.status}`;
                    type = 'status-update';
                    break;
                default:
                    message = data.message || 'æ”¶åˆ°é€šçŸ¥';
            }
            
            showNotification(message, data.timestamp || new Date().toLocaleString(), type);
        }

        function showNotification(message, timestamp, type = 'info') {
            const notificationsContainer = document.getElementById('notifications');
            
            // ç§»é™¤"æš«ç„¡é€šçŸ¥"æ¶ˆæ¯
            const noData = notificationsContainer.querySelector('.no-data');
            if (noData) {
                noData.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-time">${timestamp}</div>
                <div class="notification-message">${message}</div>
            `;
            
            notificationsContainer.insertBefore(notification, notificationsContainer.firstChild);
            
            // é™åˆ¶é€šçŸ¥æ•¸é‡
            const allNotifications = notificationsContainer.querySelectorAll('.notification');
            if (allNotifications.length > 20) {
                allNotifications[allNotifications.length - 1].remove();
            }
            
            notifications.push({ message, timestamp, type });
        }

        function addOrderControls(order) {
            const notificationsContainer = document.getElementById('notifications');
            const orderControl = document.createElement('div');
            orderControl.className = 'notification new-order';
            orderControl.innerHTML = `
                <div class="notification-time">${order.timestamp}</div>
                <div class="notification-message">è¨‚å–® ${order.id}</div>
                <div class="order-controls">
                    <div>ç‹€æ…‹: <strong>${order.status}</strong></div>
                    <div class="status-buttons">
                        <button class="status-btn pending" onclick="updateOrderStatus('${order.id}', 'pending')">å¾…è™•ç†</button>
                        <button class="status-btn processing" onclick="updateOrderStatus('${order.id}', 'processing')">è™•ç†ä¸­</button>
                        <button class="status-btn completed" onclick="updateOrderStatus('${order.id}', 'completed')">å·²å®Œæˆ</button>
                        <button class="status-btn failed" onclick="updateOrderStatus('${order.id}', 'failed')">å¤±æ•—</button>
                    </div>
                </div>
            `;
            
            notificationsContainer.insertBefore(orderControl, notificationsContainer.firstChild);
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: status,
                        message: `ç‹€æ…‹ç”±ç³»çµ±æ›´æ–°ç‚º: ${status}`,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showNotification(`è¨‚å–® ${orderId} ç‹€æ…‹å·²æ›´æ–°ç‚º: ${status}`, new Date().toLocaleString(), 'status-update');
                } else {
                    throw new Error('æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
                showNotification(`æ›´æ–°è¨‚å–® ${orderId} ç‹€æ…‹å¤±æ•—`, new Date().toLocaleString(), 'error');
            }
        }

        function clearNotifications() {
            const notificationsContainer = document.getElementById('notifications');
            notificationsContainer.innerHTML = '<div class="no-data">æš«ç„¡é€šçŸ¥</div>';
            notifications = [];
        }

        // è—¥ç‰©æœå°‹åŠŸèƒ½
        let searchTimeout;
        document.getElementById('medicineSearch').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length > 0) {
                searchTimeout = setTimeout(() => searchMedicine(query), 300);
            } else {
                document.getElementById('medicineResults').innerHTML = '<div class="no-data">è«‹è¼¸å…¥è—¥ç‰©åç¨±é€²è¡Œæœå°‹</div>';
                currentMedicine = null;
            }
        });

        async function searchMedicine(medicineName) {
            try {
                currentMedicine = medicineName;
                const response = await fetch(`/api/medicine/integrated/${encodeURIComponent(medicineName)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    displayMedicineInfo(data);
                } else {
                    document.getElementById('medicineResults').innerHTML = '<div class="no-data">æ‰¾ä¸åˆ°ç›¸é—œè—¥ç‰©è³‡æ–™</div>';
                }
            } catch (error) {
                console.error('æœå°‹è—¥ç‰©å¤±æ•—:', error);
                document.getElementById('medicineResults').innerHTML = '<div class="no-data">æœå°‹ç™¼ç”ŸéŒ¯èª¤</div>';
            }
        }

        function displayMedicineInfo(data) {
            const resultsContainer = document.getElementById('medicineResults');
            
            let html = `<div class="medicine-info">`;
            html += `<h4>ğŸ’Š ${data.medicine_name}</h4>`;
            
            if (data.basic_data) {
                html += `<div class="medicine-details">`;
                html += `<div><strong>æ•¸é‡:</strong> ${data.basic_data.amount || 'N/A'}</div>`;
                html += `<div><strong>ä½ç½®:</strong> ${data.basic_data.position || 'N/A'}</div>`;
                html += `<div><strong>è£½é€ å•†:</strong> ${data.basic_data.manufacturer || 'N/A'}</div>`;
                html += `<div><strong>åŠ‘é‡:</strong> ${data.basic_data.dosage || 'N/A'}</div>`;
                html += `<div><strong>å»ºç«‹æ™‚é–“:</strong> ${data.basic_data.created_time || 'N/A'}</div>`;
                html += `<div><strong>æ›´æ–°æ™‚é–“:</strong> ${data.basic_data.updated_time || 'N/A'}</div>`;
                html += `</div>`;
            }
            
            if (data.detailed_data) {
                html += `<hr style="margin: 15px 0;">`;
                html += `<div class="medicine-details">`;
                html += `<div><strong>æˆåˆ†:</strong> ${data.detailed_data.ingredient || 'N/A'}</div>`;
                html += `<div><strong>åˆ†é¡:</strong> ${data.detailed_data.category || 'N/A'}</div>`;
                html += `<div><strong>é©æ‡‰ç—‡:</strong> ${data.detailed_data.description || 'N/A'}</div>`;
                html += `<div><strong>å‰¯ä½œç”¨:</strong> ${data.detailed_data.side_effects || 'N/A'}</div>`;
                html += `<div><strong>æœ‰æ•ˆæœŸé™:</strong> ${data.detailed_data.expiry_date || 'N/A'}</div>`;
                html += `<div><strong>æ¢ç¢¼:</strong> ${data.detailed_data.barcode || 'N/A'}</div>`;
                html += `</div>`;
            }
            
            html += `</div>`;
            resultsContainer.innerHTML = html;
        }

        // å¿«é€Ÿæ“ä½œå‡½æ•¸
        async function refreshMedicines() {
            showNotification('æ­£åœ¨é‡æ–°æ•´ç†è—¥ç‰©è³‡æ–™...', new Date().toLocaleString(), 'info');
            if (currentMedicine) {
                await searchMedicine(currentMedicine);
            }
        }

        async function viewAllOrders() {
            try {
                const response = await fetch('/api/orders');
                const data = await response.json();
                
                showNotification(`ç›®å‰å…±æœ‰ ${data.orders.length} ç­†è¨‚å–®`, new Date().toLocaleString(), 'info');
                console.log('æ‰€æœ‰è¨‚å–®:', data.orders);
            } catch (error) {
                showNotification('å–å¾—è¨‚å–®è³‡æ–™å¤±æ•—', new Date().toLocaleString(), 'error');
            }
        }

        function openIntegratedForm() {
            window.open('/medicine_integrated.html', '_blank');
        }

        async function testROS2Connection() {
            try {
                const response = await fetch('/api/ros2/medicine/basic');
                if (response.ok) {
                    showNotification('ğŸ¤– ROS2 APIé€£æ¥æ­£å¸¸', new Date().toLocaleString(), 'success');
                } else {
                    throw new Error('é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                showNotification('ğŸ¤– ROS2 APIé€£æ¥å¤±æ•—', new Date().toLocaleString(), 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            showNotification('ç›£æ§ç³»çµ±å·²å•Ÿå‹•', new Date().toLocaleString(), 'success');
        });
    </script>
</body>
</html>