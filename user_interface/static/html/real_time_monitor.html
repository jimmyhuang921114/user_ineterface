<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 實時監控系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title .emoji {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .medicine-search {
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .medicine-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .medicine-info h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .medicine-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-out;
        }

        .notification.new-order {
            border-left-color: #ffc107;
        }

        .notification.status-update {
            border-left-color: #28a745;
        }

        .notification.medicine-update {
            border-left-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-time {
            font-size: 12px;
            color: #999;
            float: right;
        }

        .notification-message {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .order-controls {
            margin-top: 20px;
        }

        .status-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .status-btn.pending {
            background: #ffc107;
            color: white;
        }

        .status-btn.processing {
            background: #17a2b8;
            color: white;
        }

        .status-btn.completed {
            background: #28a745;
            color: white;
        }

        .status-btn.failed {
            background: #dc3545;
            color: white;
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        .clear-btn:hover {
            background: #5a6268;
        }

        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 實時藥物管理監控系統</h1>
            <p>
                <span class="status-indicator" id="connectionStatus"></span>
                <span id="connectionText">連接中...</span>
            </p>
        </div>

        <div class="main-content">
            <!-- 藥物查詢區域 -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">💊</span>
                    藥物資料查詢
                </div>
                
                <div class="medicine-search">
                    <input type="text" id="medicineSearch" class="search-input" 
                           placeholder="輸入藥物名稱搜尋..." />
                </div>
                
                <div id="medicineResults">
                    <div class="no-data">請輸入藥物名稱進行搜尋</div>
                </div>
            </div>

            <!-- 實時通知區域 -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">🔔</span>
                    實時通知
                    <button class="clear-btn" onclick="clearNotifications()" style="margin-left: auto;">清除通知</button>
                </div>
                
                <div id="notifications">
                    <div class="no-data">暫無通知</div>
                </div>
            </div>
        </div>

        <!-- 快速操作區域 -->
        <div class="quick-actions">
            <button class="action-btn" onclick="refreshMedicines()">🔄 重新整理藥物資料</button>
            <button class="action-btn" onclick="viewAllOrders()">📦 查看所有訂單</button>
            <button class="action-btn" onclick="openIntegratedForm()">➕ 新增藥物</button>
            <button class="action-btn" onclick="testROS2Connection()">🤖 測試ROS2連接</button>
        </div>
    </div>

    <script>
        let websocket = null;
        let notifications = [];
        let currentMedicine = null;

        // WebSocket連接
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket連接成功');
                updateConnectionStatus(true);
                showNotification('系統連接成功', 'WebSocket連接已建立', 'success');
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleRealtimeNotification(data);
                } catch (error) {
                    console.error('解析WebSocket消息失敗:', error);
                }
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket連接關閉');
                updateConnectionStatus(false);
                // 自動重連
                setTimeout(connectWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket錯誤:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = '即時連線中';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = '連線中斷';
            }
        }

        function handleRealtimeNotification(data) {
            let message = '';
            let type = data.type || 'info';
            
            switch (data.type) {
                case 'medicine_basic_updated':
                    message = `藥物基本資料已更新: ${data.medicine.name}`;
                    type = 'medicine-update';
                    // 如果正在查看此藥物，自動更新
                    if (currentMedicine === data.medicine.name) {
                        searchMedicine(data.medicine.name);
                    }
                    break;
                case 'medicine_detailed_updated':
                    message = `藥物詳細資料已更新: ${data.medicine.medicine_name}`;
                    type = 'medicine-update';
                    // 如果正在查看此藥物，自動更新
                    if (currentMedicine === data.medicine.medicine_name) {
                        searchMedicine(data.medicine.medicine_name);
                    }
                    break;
                case 'new_order':
                    message = `收到新訂單: ${data.order.id}`;
                    type = 'new-order';
                    addOrderControls(data.order);
                    break;
                case 'ros2_order_request':
                    message = `🤖 ${data.message}`;
                    type = 'new-order';
                    addOrderControls(data.order);
                    break;
                case 'order_status_updated':
                    message = `訂單狀態更新: ${data.order_id} -> ${data.status}`;
                    type = 'status-update';
                    break;
                default:
                    message = data.message || '收到通知';
            }
            
            showNotification(message, data.timestamp || new Date().toLocaleString(), type);
        }

        function showNotification(message, timestamp, type = 'info') {
            const notificationsContainer = document.getElementById('notifications');
            
            // 移除"暫無通知"消息
            const noData = notificationsContainer.querySelector('.no-data');
            if (noData) {
                noData.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-time">${timestamp}</div>
                <div class="notification-message">${message}</div>
            `;
            
            notificationsContainer.insertBefore(notification, notificationsContainer.firstChild);
            
            // 限制通知數量
            const allNotifications = notificationsContainer.querySelectorAll('.notification');
            if (allNotifications.length > 20) {
                allNotifications[allNotifications.length - 1].remove();
            }
            
            notifications.push({ message, timestamp, type });
        }

        function addOrderControls(order) {
            const notificationsContainer = document.getElementById('notifications');
            const orderControl = document.createElement('div');
            orderControl.className = 'notification new-order';
            orderControl.innerHTML = `
                <div class="notification-time">${order.timestamp}</div>
                <div class="notification-message">訂單 ${order.id}</div>
                <div class="order-controls">
                    <div>狀態: <strong>${order.status}</strong></div>
                    <div class="status-buttons">
                        <button class="status-btn pending" onclick="updateOrderStatus('${order.id}', 'pending')">待處理</button>
                        <button class="status-btn processing" onclick="updateOrderStatus('${order.id}', 'processing')">處理中</button>
                        <button class="status-btn completed" onclick="updateOrderStatus('${order.id}', 'completed')">已完成</button>
                        <button class="status-btn failed" onclick="updateOrderStatus('${order.id}', 'failed')">失敗</button>
                    </div>
                </div>
            `;
            
            notificationsContainer.insertBefore(orderControl, notificationsContainer.firstChild);
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: status,
                        message: `狀態由系統更新為: ${status}`,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showNotification(`訂單 ${orderId} 狀態已更新為: ${status}`, new Date().toLocaleString(), 'status-update');
                } else {
                    throw new Error('更新失敗');
                }
            } catch (error) {
                console.error('更新訂單狀態失敗:', error);
                showNotification(`更新訂單 ${orderId} 狀態失敗`, new Date().toLocaleString(), 'error');
            }
        }

        function clearNotifications() {
            const notificationsContainer = document.getElementById('notifications');
            notificationsContainer.innerHTML = '<div class="no-data">暫無通知</div>';
            notifications = [];
        }

        // 藥物搜尋功能
        let searchTimeout;
        document.getElementById('medicineSearch').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length > 0) {
                searchTimeout = setTimeout(() => searchMedicine(query), 300);
            } else {
                document.getElementById('medicineResults').innerHTML = '<div class="no-data">請輸入藥物名稱進行搜尋</div>';
                currentMedicine = null;
            }
        });

        async function searchMedicine(medicineName) {
            try {
                currentMedicine = medicineName;
                const response = await fetch(`/api/medicine/integrated/${encodeURIComponent(medicineName)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    displayMedicineInfo(data);
                } else {
                    document.getElementById('medicineResults').innerHTML = '<div class="no-data">找不到相關藥物資料</div>';
                }
            } catch (error) {
                console.error('搜尋藥物失敗:', error);
                document.getElementById('medicineResults').innerHTML = '<div class="no-data">搜尋發生錯誤</div>';
            }
        }

        function displayMedicineInfo(data) {
            const resultsContainer = document.getElementById('medicineResults');
            
            let html = `<div class="medicine-info">`;
            html += `<h4>💊 ${data.medicine_name}</h4>`;
            
            if (data.basic_data) {
                html += `<div class="medicine-details">`;
                html += `<div><strong>數量:</strong> ${data.basic_data.amount || 'N/A'}</div>`;
                html += `<div><strong>位置:</strong> ${data.basic_data.position || 'N/A'}</div>`;
                html += `<div><strong>製造商:</strong> ${data.basic_data.manufacturer || 'N/A'}</div>`;
                html += `<div><strong>劑量:</strong> ${data.basic_data.dosage || 'N/A'}</div>`;
                html += `<div><strong>建立時間:</strong> ${data.basic_data.created_time || 'N/A'}</div>`;
                html += `<div><strong>更新時間:</strong> ${data.basic_data.updated_time || 'N/A'}</div>`;
                html += `</div>`;
            }
            
            if (data.detailed_data) {
                html += `<hr style="margin: 15px 0;">`;
                html += `<div class="medicine-details">`;
                html += `<div><strong>成分:</strong> ${data.detailed_data.ingredient || 'N/A'}</div>`;
                html += `<div><strong>分類:</strong> ${data.detailed_data.category || 'N/A'}</div>`;
                html += `<div><strong>適應症:</strong> ${data.detailed_data.description || 'N/A'}</div>`;
                html += `<div><strong>副作用:</strong> ${data.detailed_data.side_effects || 'N/A'}</div>`;
                html += `<div><strong>有效期限:</strong> ${data.detailed_data.expiry_date || 'N/A'}</div>`;
                html += `<div><strong>條碼:</strong> ${data.detailed_data.barcode || 'N/A'}</div>`;
                html += `</div>`;
            }
            
            html += `</div>`;
            resultsContainer.innerHTML = html;
        }

        // 快速操作函數
        async function refreshMedicines() {
            showNotification('正在重新整理藥物資料...', new Date().toLocaleString(), 'info');
            if (currentMedicine) {
                await searchMedicine(currentMedicine);
            }
        }

        async function viewAllOrders() {
            try {
                const response = await fetch('/api/orders');
                const data = await response.json();
                
                showNotification(`目前共有 ${data.orders.length} 筆訂單`, new Date().toLocaleString(), 'info');
                console.log('所有訂單:', data.orders);
            } catch (error) {
                showNotification('取得訂單資料失敗', new Date().toLocaleString(), 'error');
            }
        }

        function openIntegratedForm() {
            window.open('/medicine_integrated.html', '_blank');
        }

        async function testROS2Connection() {
            try {
                const response = await fetch('/api/ros2/medicine/basic');
                if (response.ok) {
                    showNotification('🤖 ROS2 API連接正常', new Date().toLocaleString(), 'success');
                } else {
                    throw new Error('連接失敗');
                }
            } catch (error) {
                showNotification('🤖 ROS2 API連接失敗', new Date().toLocaleString(), 'error');
            }
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            showNotification('監控系統已啟動', new Date().toLocaleString(), 'success');
        });
    </script>
</body>
</html>