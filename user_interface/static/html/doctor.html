<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫院藥物管理系統 - 醫生管理</title>

    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>

    <!-- 樣式表 -->
    <link rel="stylesheet" href="../css/unified_style.css">
</head>
<body>
    <div class="sidebar">
        <h2>醫院管理系統</h2>
        <button onclick="location.href='doctor.html'" class="active">醫生管理</button>
        <button onclick="location.href='Medicine.html'">藥物管理</button>
        <button onclick="location.href='Prescription.html'">處方管理</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>醫生管理系統</h1>
            <p>醫院藥物與患者管理系統</p>
        </div>

        <div class="tab-container fade-in">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('basic')">基本藥物</button>
                <button class="tab-button" onclick="switchTab('detailed')">詳細藥物</button>
                <button class="tab-button" onclick="switchTab('prescription')">處方管理</button>
            </div>

            <!-- 基本藥物管理 -->
            <div id="basic" class="tab-content active">
                <div class="form-section">
                    <h3>新增基本藥物</h3>
                    <form id="basicMedicineForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="basicMedicineName" class="required">藥物名稱</label>
                                <input type="text" id="basicMedicineName" placeholder="輸入藥物名稱" required>
                            </div>
                            <div class="form-group">
                                <label for="basicAmount" class="required">數量</label>
                                <input type="number" id="basicAmount" placeholder="輸入數量" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="basicUsageDays" class="required">使用天數</label>
                                <input type="number" id="basicUsageDays" placeholder="輸入天數" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="basicPosition" class="required">儲存位置</label>
                                <input type="text" id="basicPosition" placeholder="A1-01, B2-15" required>
                            </div>
                        </div>
                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">新增藥物</button>
                            <button type="button" class="btn btn-warning" onclick="clearBasicForm()">清除表單</button>
                        </div>
                    </form>
                </div>

                <div id="basicMessage" class="message"></div>
            </div>

            <!-- 詳細藥物管理 -->
            <div id="detailed" class="tab-content">
                <div class="form-section">
                    <h3>新增詳細藥物資料</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">為現有藥物添加詳細資訊</p>

                    <form id="detailedMedicineForm">
                        <!-- 藥物選擇 -->
                        <div class="form-group">
                            <label for="detailedMedicineName" class="required">選擇藥物</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="detailedMedicineName" required style="flex: 1;">
                                    <option value="">-- 請選擇藥物 --</option>
                                </select>
                                <button type="button" class="btn btn-info" onclick="loadMedicineOptions()">載入藥物</button>
                            </div>
                        </div>

                        <!-- 詳細資訊 -->
                        <div class="form-section">
                            <h4>詳細資訊 (JSON格式)</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
                                請輸入JSON格式的詳細藥物資訊
                            </p>

                            <div class="form-group">
                                <label for="medicineDescription">藥物詳細資料</label>
                                <textarea id="medicineDescription" rows="4"
                                    placeholder="請輸入JSON格式的藥物詳細資料..."></textarea>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="manufacturer">製造商</label>
                                    <input type="text" id="manufacturer" placeholder="輸入製造商名稱">
                                </div>
                                <div class="form-group">
                                    <label for="ingredients">主要成分</label>
                                    <input type="text" id="ingredients" placeholder="輸入主要成分">
                                </div>
                                <div class="form-group">
                                    <label for="indications">適應症</label>
                                    <input type="text" id="indications" placeholder="輸入適應症">
                                </div>
                                <div class="form-group">
                                    <label for="dosage">用法用量</label>
                                    <input type="text" id="dosage" placeholder="輸入用法用量">
                                </div>
                            </div>

                            <div style="margin-top: 25px;">
                                <button type="submit" class="btn btn-success">新增詳細資料</button>
                                <button type="button" class="btn btn-warning" onclick="clearDetailedForm()">清除表單</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="detailedMessage" class="message"></div>
            </div>

            <!-- 處方管理 -->
            <div id="prescription" class="tab-content">
                <div class="form-section">
                    <h3>處方管理</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">管理患者處方資訊</p>

                    <form id="prescriptionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="patientName" class="required">患者姓名</label>
                                <input type="text" id="patientName" placeholder="輸入患者姓名" required>
                            </div>
                            <div class="form-group">
                                <label for="doctorName" class="required">醫生姓名</label>
                                <input type="text" id="doctorName" placeholder="輸入醫生姓名" required>
                            </div>
                            <div class="form-group">
                                <label for="diagnosis">診斷</label>
                                <input type="text" id="diagnosis" placeholder="輸入診斷結果">
                            </div>
                            <div class="form-group">
                                <label for="priority">優先級</label>
                                <select id="priority">
                                    <option value="normal">一般</option>
                                    <option value="urgent">緊急</option>
                                    <option value="routine">例行</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>處方藥物</h4>
                            <div id="medicineList">
                                <div class="medicine-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>藥物名稱</label>
                                            <input type="text" class="medicine-name" placeholder="輸入藥物名稱">
                                        </div>
                                        <div class="form-group">
                                            <label>劑量</label>
                                            <input type="text" class="medicine-dosage" placeholder="輸入劑量">
                                        </div>
                                        <div class="form-group">
                                            <label>頻率</label>
                                            <input type="text" class="medicine-frequency" placeholder="每日幾次">
                                        </div>
                                        <div class="form-group">
                                            <label>療程</label>
                                            <input type="text" class="medicine-duration" placeholder="幾天">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger" onclick="removeMedicine(this)">移除藥物</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-info" onclick="addMedicine()">新增藥物</button>
                        </div>

                        <div class="form-group">
                            <label for="instructions">用藥指示</label>
                            <textarea id="instructions" rows="3" placeholder="輸入用藥指示..."></textarea>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">建立處方</button>
                            <button type="button" class="btn btn-warning" onclick="clearPrescriptionForm()">清除表單</button>
                        </div>
                    </form>
                </div>

                <div id="prescriptionMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentTab = 'basic';

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeForms();
        });

        // 初始化表單
        function initializeForms() {
            // 基本藥物表單
            document.getElementById('basicMedicineForm').addEventListener('submit', handleBasicMedicineSubmit);
            
            // 詳細藥物表單
            document.getElementById('detailedMedicineForm').addEventListener('submit', handleDetailedMedicineSubmit);
            
            // 處方表單
            document.getElementById('prescriptionForm').addEventListener('submit', handlePrescriptionSubmit);
        }

        // 切換標籤
        function switchTab(tabName) {
            // 隱藏所有標籤內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有標籤按鈕的active狀態
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 顯示選中的標籤內容
            document.getElementById(tabName).classList.add('active');
            
            // 設定選中標籤按鈕的active狀態
            event.target.classList.add('active');
            
            currentTab = tabName;
        }

        // 處理基本藥物提交
        async function handleBasicMedicineSubmit(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('basicMedicineName').value,
                amount: parseInt(document.getElementById('basicAmount').value),
                usage_days: parseInt(document.getElementById('basicUsageDays').value),
                position: document.getElementById('basicPosition').value
            };

            try {
                const response = await fetch('/api/medicine/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('基本藥物新增成功', 'success', 'basicMessage');
                    clearBasicForm();
                } else {
                    showMessage('基本藥物新增失敗', 'error', 'basicMessage');
                }
            } catch (error) {
                console.error('提交失敗:', error);
                showMessage('提交失敗', 'error', 'basicMessage');
            }
        }

        // 處理詳細藥物提交
        async function handleDetailedMedicineSubmit(event) {
            event.preventDefault();
            
            const medicineName = document.getElementById('detailedMedicineName').value;
            const description = document.getElementById('medicineDescription').value;
            
            if (!medicineName || !description) {
                showMessage('請填寫完整資訊', 'warning', 'detailedMessage');
                return;
            }

            try {
                let medicineData;
                try {
                    medicineData = JSON.parse(description);
                } catch (e) {
                    showMessage('JSON格式錯誤', 'error', 'detailedMessage');
                    return;
                }

                const response = await fetch(`/api/medicine/detailed/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        medicine_name: medicineName,
                        medicine_data: medicineData
                    })
                });

                if (response.ok) {
                    showMessage('詳細藥物資料新增成功', 'success', 'detailedMessage');
                    clearDetailedForm();
                } else {
                    showMessage('詳細藥物資料新增失敗', 'error', 'detailedMessage');
                }
            } catch (error) {
                console.error('提交失敗:', error);
                showMessage('提交失敗', 'error', 'detailedMessage');
            }
        }

        // 處理處方提交
        async function handlePrescriptionSubmit(event) {
            event.preventDefault();
            
            const medicines = [];
            document.querySelectorAll('.medicine-item').forEach(item => {
                const name = item.querySelector('.medicine-name').value;
                const dosage = item.querySelector('.medicine-dosage').value;
                const frequency = item.querySelector('.medicine-frequency').value;
                const duration = item.querySelector('.medicine-duration').value;
                
                if (name && dosage && frequency && duration) {
                    medicines.push({
                        medicine_name: name,
                        dosage: dosage,
                        frequency: frequency,
                        duration: duration
                    });
                }
            });

            const formData = {
                patient_name: document.getElementById('patientName').value,
                doctor_name: document.getElementById('doctorName').value,
                diagnosis: document.getElementById('diagnosis').value,
                medicines: medicines,
                instructions: document.getElementById('instructions').value,
                priority: document.getElementById('priority').value
            };

            try {
                const response = await fetch('/api/prescription/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showMessage('處方建立成功', 'success', 'prescriptionMessage');
                    clearPrescriptionForm();
                } else {
                    showMessage('處方建立失敗', 'error', 'prescriptionMessage');
                }
            } catch (error) {
                console.error('提交失敗:', error);
                showMessage('提交失敗', 'error', 'prescriptionMessage');
            }
        }

        // 載入藥物選項
        async function loadMedicineOptions() {
            try {
                const response = await fetch('/api/medicine/');
                const medicines = await response.json();
                
                const select = document.getElementById('detailedMedicineName');
                select.innerHTML = '<option value="">-- 請選擇藥物 --</option>';
                
                medicines.forEach(medicine => {
                    const option = document.createElement('option');
                    option.value = medicine.name;
                    option.textContent = medicine.name;
                    select.appendChild(option);
                });
                
                showMessage('藥物選項載入成功', 'success', 'detailedMessage');
            } catch (error) {
                console.error('載入失敗:', error);
                showMessage('載入藥物選項失敗', 'error', 'detailedMessage');
            }
        }

        // 新增藥物項目
        function addMedicine() {
            const medicineList = document.getElementById('medicineList');
            const medicineItem = document.createElement('div');
            medicineItem.className = 'medicine-item';
            medicineItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;';
            
            medicineItem.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>藥物名稱</label>
                        <input type="text" class="medicine-name" placeholder="輸入藥物名稱">
                    </div>
                    <div class="form-group">
                        <label>劑量</label>
                        <input type="text" class="medicine-dosage" placeholder="輸入劑量">
                    </div>
                    <div class="form-group">
                        <label>頻率</label>
                        <input type="text" class="medicine-frequency" placeholder="每日幾次">
                    </div>
                    <div class="form-group">
                        <label>療程</label>
                        <input type="text" class="medicine-duration" placeholder="幾天">
                    </div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeMedicine(this)">移除藥物</button>
            `;
            
            medicineList.appendChild(medicineItem);
        }

        // 移除藥物項目
        function removeMedicine(button) {
            button.parentElement.remove();
        }

        // 清除基本表單
        function clearBasicForm() {
            document.getElementById('basicMedicineForm').reset();
            showMessage('表單已清除', 'info', 'basicMessage');
        }

        // 清除詳細表單
        function clearDetailedForm() {
            document.getElementById('detailedMedicineForm').reset();
            showMessage('表單已清除', 'info', 'detailedMessage');
        }

        // 清除處方表單
        function clearPrescriptionForm() {
            document.getElementById('prescriptionForm').reset();
            document.getElementById('medicineList').innerHTML = `
                <div class="medicine-item" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>藥物名稱</label>
                            <input type="text" class="medicine-name" placeholder="輸入藥物名稱">
                        </div>
                        <div class="form-group">
                            <label>劑量</label>
                            <input type="text" class="medicine-dosage" placeholder="輸入劑量">
                        </div>
                        <div class="form-group">
                            <label>頻率</label>
                            <input type="text" class="medicine-frequency" placeholder="每日幾次">
                        </div>
                        <div class="form-group">
                            <label>療程</label>
                            <input type="text" class="medicine-duration" placeholder="幾天">
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeMedicine(this)">移除藥物</button>
                </div>
            `;
            showMessage('表單已清除', 'info', 'prescriptionMessage');
        }

        // 顯示訊息
        function showMessage(message, type = 'info', elementId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            if (elementId) {
                const container = document.getElementById(elementId);
                container.innerHTML = '';
                container.appendChild(messageDiv);
            } else {
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.right = '20px';
                messageDiv.style.zIndex = '10000';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>