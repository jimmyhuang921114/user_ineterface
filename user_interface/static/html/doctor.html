<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç”Ÿå·¥ä½œå° - é†«é™¢ç®¡ç†ç³»çµ±</title>
    
    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>
    
    <!-- çµ±ä¸€é¢¨æ ¼ -->
    <link rel="stylesheet" href="../css/unified_style.css">
</head>
<body>
    <div class="sidebar">
        <h2>é†«é™¢ç®¡ç†ç³»çµ±</h2>
        <button onclick="location.href='doctor.html'" class="active">é†«ç”Ÿå·¥ä½œå°</button>
        <button onclick="location.href='Medicine.html'">è—¥ç‰©åº«å­˜ç®¡ç†</button>
        <button onclick="location.href='Prescription.html'">è™•æ–¹ç®¡ç†ç³»çµ±</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>é†«ç”Ÿå·¥ä½œå°</h1>
            <p>è—¥ç‰©è³‡è¨Šç®¡ç†èˆ‡è™•æ–¹é–‹ç«‹ç³»çµ± - è³‡æ–™ç›´æ¥å„²å­˜è‡³é†«é™¢ç®¡ç†ç³»çµ±</p>
        </div>

        <div class="tab-container fade-in">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('basic')">åŸºæœ¬è—¥ç‰©ç®¡ç†</button>
                <button class="tab-button" onclick="switchTab('detailed')">è©³ç´°è—¥ç‰©è³‡è¨Š</button>
                <button class="tab-button" onclick="switchTab('prescription')">è™•æ–¹é–‹ç«‹</button>
            </div>

            <!-- åŸºæœ¬è—¥ç‰©è³‡è¨Šæ¨™ç±¤ -->
            <div id="basic" class="tab-content active">
                <div class="form-section">
                    <h3>æ–°å¢åŸºæœ¬è—¥ç‰©è³‡è¨Š</h3>
                    <form id="basicMedicineForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="basicMedicineName" class="required">è—¥ç‰©åç¨±</label>
                                <input type="text" id="basicMedicineName" placeholder="è«‹è¼¸å…¥è—¥ç‰©åç¨±" required>
                            </div>
                            <div class="form-group">
                                <label for="basicAmount" class="required">åº«å­˜æ•¸é‡</label>
                                <input type="number" id="basicAmount" placeholder="è«‹è¼¸å…¥æ•¸é‡" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="basicUsageDays" class="required">å»ºè­°ä½¿ç”¨å¤©æ•¸</label>
                                <input type="number" id="basicUsageDays" placeholder="è«‹è¼¸å…¥å¤©æ•¸" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="basicPosition" class="required">å­˜æ”¾ä½ç½®</label>
                                <input type="text" id="basicPosition" placeholder="ä¾‹ï¼šA1-01, B2-15" required>
                            </div>
                        </div>
                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">ğŸ’¾ å„²å­˜åŸºæœ¬è³‡è¨Š</button>
                            <button type="button" class="btn btn-warning" onclick="clearBasicForm()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å–®</button>
                        </div>
                    </form>
                </div>
                
                <div id="basicMessage" class="message"></div>
            </div>

            <!-- è©³ç´°è—¥ç‰©è³‡è¨Šæ¨™ç±¤ -->
            <div id="detailed" class="tab-content">
                <div class="form-section">
                    <h3>è©³ç´°è—¥ç‰©è³‡è¨Šç®¡ç†</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">è«‹å…ˆåœ¨ã€ŒåŸºæœ¬è—¥ç‰©ç®¡ç†ã€ä¸­æ–°å¢è—¥ç‰©ï¼Œå†é¸æ“‡è—¥ç‰©å¡«å¯«è©³ç´°è³‡è¨Š</p>
                    
                    <form id="detailedMedicineForm">
                        <!-- é¸æ“‡è—¥ç‰© -->
                        <div class="form-group">
                            <label for="detailedMedicineName" class="required">é¸æ“‡è—¥ç‰©</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="detailedMedicineName" required style="flex: 1;">
                                    <option value="">-- è«‹é¸æ“‡å·²æ–°å¢çš„è—¥ç‰© --</option>
                                </select>
                                <button type="button" class="btn btn-info" onclick="loadMedicineOptions()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                            </div>
                        </div>

                        <!-- è‡ªç”±æ ¼å¼è©³ç´°è³‡è¨Š -->
                        <div class="form-section">
                            <h4>ğŸ“‹ è—¥ç‰©è©³ç´°è³‡è¨Š (è‡ªç”±å¡«å¯«)</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
                                æ‚¨å¯ä»¥è‡ªç”±å¡«å¯«è—¥ç‰©çš„è©³ç´°è³‡è¨Šï¼Œç³»çµ±æœƒå°‡è³‡æ–™ä»¥JSONæ ¼å¼å„²å­˜
                            </p>
                            
                            <div class="form-group">
                                <label for="medicineDescription">ğŸ“ è—¥ç‰©æè¿°èˆ‡é©æ‡‰ç—‡</label>
                                <textarea id="medicineDescription" rows="4" 
                                    placeholder="è«‹æè¿°è—¥ç‰©çš„ä¸»è¦åŠŸæ•ˆã€é©æ‡‰ç—‡ã€ä½¿ç”¨æ–¹å¼ç­‰..."></textarea>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineManufacturer">ğŸ­ è£½é€ å•†</label>
                                    <input type="text" id="medicineManufacturer" placeholder="ä¾‹ï¼šå°ç£è£½è—¥å…¬å¸">
                                </div>
                                <div class="form-group">
                                    <label for="medicineDosage">ğŸ’Š åŠ‘é‡è¦æ ¼</label>
                                    <input type="text" id="medicineDosage" placeholder="ä¾‹ï¼š10mg, 500mg">
                                </div>
                                <div class="form-group">
                                    <label for="medicineColor">ğŸ¨ å¤–è§€é¡è‰²</label>
                                    <input type="text" id="medicineColor" placeholder="ä¾‹ï¼šç™½è‰²ã€è—è‰²">
                                </div>
                                <div class="form-group">
                                    <label for="medicineShape">âšª å¤–è§€å½¢ç‹€</label>
                                    <input type="text" id="medicineShape" placeholder="ä¾‹ï¼šåœ“å½¢ã€æ©¢åœ“å½¢">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="medicineSideEffects">âš ï¸ ä¸»è¦å‰¯ä½œç”¨</label>
                                <textarea id="medicineSideEffects" rows="3" 
                                    placeholder="è«‹åˆ—å‡ºä¸»è¦çš„å‰¯ä½œç”¨å’Œæ³¨æ„äº‹é …..."></textarea>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineStorage">ğŸŒ¡ï¸ å„²å­˜æ¢ä»¶</label>
                                    <input type="text" id="medicineStorage" placeholder="ä¾‹ï¼šå®¤æº«ä¿å­˜ã€å†·è—">
                                </div>
                                <div class="form-group">
                                    <label for="medicineExpiry">ğŸ“… æœ‰æ•ˆæœŸé™</label>
                                    <input type="date" id="medicineExpiry">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="medicineNotes">ğŸ“‹ å…¶ä»–å‚™è¨»</label>
                                <textarea id="medicineNotes" rows="3" 
                                    placeholder="å…¶ä»–é‡è¦è³‡è¨Šã€ç‰¹æ®Šæ³¨æ„äº‹é …ç­‰..."></textarea>
                            </div>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">ğŸ’¾ å„²å­˜è©³ç´°è³‡è¨Š</button>
                            <button type="button" class="btn btn-warning" onclick="clearDetailedForm()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å–®</button>
                        </div>
                    </form>
                </div>
                
                <div id="detailedMessage" class="message"></div>
            </div>

            <!-- é–‹ç«‹è™•æ–¹æ¨™ç±¤ -->
            <div id="prescription" class="tab-content">
                <div class="form-section">
                    <h3>è™•æ–¹é–‹ç«‹ç³»çµ±</h3>
                    <form id="prescriptionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="patientName" class="required">ç—…æ‚£å§“å</label>
                                <input type="text" id="patientName" placeholder="è«‹è¼¸å…¥ç—…æ‚£å§“å" required>
                            </div>
                            <div class="form-group">
                                <label for="patientId">ç—…æ‚£èº«åˆ†è­‰å­—è™Ÿ</label>
                                <input type="text" id="patientId" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ">
                            </div>
                            <div class="form-group">
                                <label for="doctorName" class="required">ä¸»æ²»é†«å¸«</label>
                                <input type="text" id="doctorName" placeholder="è«‹è¼¸å…¥é†«å¸«å§“å" required>
                            </div>
                            <div class="form-group">
                                <label for="prescriptionDate">è™•æ–¹æ—¥æœŸ</label>
                                <input type="date" id="prescriptionDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="diagnosis">ğŸ©º è¨ºæ–·çµæœ</label>
                            <textarea id="diagnosis" rows="3" placeholder="è«‹è¼¸å…¥è¨ºæ–·çµæœæˆ–ç—…æƒ…æè¿°..."></textarea>
                        </div>

                        <div class="form-section">
                            <h4>ğŸ’Š è™•æ–¹è—¥ç‰©æ¸…å–®</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">
                                è«‹åœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­å¡«å¯«è™•æ–¹è—¥ç‰©ï¼Œå¯ä»¥æ–°å¢å¤šåˆ—ä¾†å¡«å¯«å¤šç¨®è—¥ç‰©
                            </p>
                            <div id="prescriptionTable" class="hot-container"></div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">ğŸ“‹ é–‹ç«‹è™•æ–¹</button>
                            <button type="button" class="btn btn-warning" onclick="clearPrescriptionForm()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å–®</button>
                            <button type="button" class="btn btn-info" onclick="addPrescriptionRow()">â• æ–°å¢è—¥ç‰©åˆ—</button>
                        </div>
                    </form>
                </div>
                
                <div id="prescriptionMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // APIåŸºç¤URL
        const API_BASE = 'http://localhost:8000';
        
        // å…¨åŸŸè®Šæ•¸
        let prescriptionHot = null;

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', () => {
            loadMedicineOptions();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
        });

        // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°è™•æ–¹æ¨™ç±¤ï¼Œåˆå§‹åŒ–è¡¨æ ¼
            if (tabName === 'prescription') {
                setTimeout(() => initPrescriptionTable(), 100);
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(elementId, message, type = 'success') {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // åŸºæœ¬è—¥ç‰©è¡¨å–®è™•ç†
        document.getElementById('basicMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('basicMedicineName').value.trim(),
                amount: parseInt(document.getElementById('basicAmount').value),
                usage_days: parseInt(document.getElementById('basicUsageDays').value),
                position: document.getElementById('basicPosition').value.trim()
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('basicMessage', `âœ… åŸºæœ¬è—¥ç‰©è³‡è¨Šå·²æˆåŠŸå„²å­˜ï¼è—¥ç‰©ID: ${result.id}`, 'success');
                    clearBasicForm();
                    loadMedicineOptions(); // é‡æ–°è¼‰å…¥è©³ç´°è³‡è¨Šçš„é¸é …
                } else {
                    const error = await response.json();
                    showMessage('basicMessage', `âŒ å„²å­˜å¤±æ•—: ${error.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showMessage('basicMessage', `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        });

        // è©³ç´°è—¥ç‰©è¡¨å–®è™•ç†
        document.getElementById('detailedMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const medicineName = document.getElementById('detailedMedicineName').value;
            if (!medicineName) {
                showMessage('detailedMessage', 'âŒ è«‹å…ˆé¸æ“‡è—¥ç‰©', 'error');
                return;
            }

            // è‡ªç”±æ ¼å¼çš„è©³ç´°è³‡è¨Š
            const medicineData = {
                åŸºæœ¬è³‡è¨Š: {
                    åç¨±: medicineName,
                    è£½é€ å•†: document.getElementById('medicineManufacturer').value || '',
                    åŠ‘é‡: document.getElementById('medicineDosage').value || ''
                },
                å¤–è§€: {
                    é¡è‰²: document.getElementById('medicineColor').value || '',
                    å½¢ç‹€: document.getElementById('medicineShape').value || ''
                },
                è—¥ç‰©æè¿°: document.getElementById('medicineDescription').value || '',
                ä¸»è¦å‰¯ä½œç”¨: document.getElementById('medicineSideEffects').value || '',
                å„²å­˜æ¢ä»¶: document.getElementById('medicineStorage').value || '',
                æœ‰æ•ˆæœŸé™: document.getElementById('medicineExpiry').value || '',
                å…¶ä»–å‚™è¨»: document.getElementById('medicineNotes').value || '',
                å»ºç«‹æ™‚é–“: new Date().toISOString(),
                å»ºç«‹äººå“¡: document.getElementById('doctorName')?.value || 'é†«ç”Ÿ'
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        medicine_name: medicineName,
                        medicine_data: medicineData
                    })
                });

                if (response.ok) {
                    showMessage('detailedMessage', `âœ… è©³ç´°è—¥ç‰©è³‡è¨Šå·²æˆåŠŸå„²å­˜ï¼`, 'success');
                    clearDetailedForm();
                } else {
                    const error = await response.json();
                    showMessage('detailedMessage', `âŒ å„²å­˜å¤±æ•—: ${error.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showMessage('detailedMessage', `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        });

        // è™•æ–¹è¡¨å–®è™•ç†
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!prescriptionHot) {
                showMessage('prescriptionMessage', 'âŒ è™•æ–¹è¡¨æ ¼å°šæœªåˆå§‹åŒ–', 'error');
                return;
            }

            const tableData = prescriptionHot.getData();
            const medicines = tableData.filter(row => 
                row[0] && row[0].trim() && row[1] && row[1].trim() && row[2] && row[2].trim() && row[3] && row[3].trim()
            ).map(row => ({
                medicine_name: row[0].trim(),
                dosage: row[1].trim(),
                frequency: row[2].trim(),
                duration: row[3].trim(),
                instructions: row[4] ? row[4].trim() : ''
            }));

            if (medicines.length === 0) {
                showMessage('prescriptionMessage', 'âŒ è«‹è‡³å°‘å¡«å¯«ä¸€å€‹è—¥ç‰©çš„å®Œæ•´è³‡è¨Š', 'error');
                return;
            }

            const prescriptionData = {
                patient_name: document.getElementById('patientName').value.trim(),
                doctor_name: document.getElementById('doctorName').value.trim(),
                diagnosis: document.getElementById('diagnosis').value.trim(),
                medicines: medicines,
                prescription_date: document.getElementById('prescriptionDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/prescription/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(prescriptionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('prescriptionMessage', `âœ… è™•æ–¹å·²æˆåŠŸé–‹ç«‹ï¼è™•æ–¹ç·¨è™Ÿ: ${result.id}`, 'success');
                    clearPrescriptionForm();
                } else {
                    const error = await response.json();
                    showMessage('prescriptionMessage', `âŒ é–‹ç«‹å¤±æ•—: ${error.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                showMessage('prescriptionMessage', `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        });

        // è¼‰å…¥è—¥ç‰©é¸é …
        async function loadMedicineOptions() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/`);
                if (response.ok) {
                    const medicines = await response.json();
                    const select = document.getElementById('detailedMedicineName');
                    
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    select.innerHTML = '<option value="">-- è«‹é¸æ“‡å·²æ–°å¢çš„è—¥ç‰© --</option>';
                    
                    // æ·»åŠ è—¥ç‰©é¸é …
                    medicines.forEach(medicine => {
                        const option = document.createElement('option');
                        option.value = medicine.name;
                        option.textContent = `${medicine.name} (ä½ç½®: ${medicine.position}, åº«å­˜: ${medicine.amount})`;
                        select.appendChild(option);
                    });
                    
                    console.log(`å·²è¼‰å…¥ ${medicines.length} å€‹è—¥ç‰©é¸é …`);
                } else {
                    console.error('è¼‰å…¥è—¥ç‰©é¸é …å¤±æ•—:', response.status);
                }
            } catch (error) {
                console.error('è¼‰å…¥è—¥ç‰©é¸é …éŒ¯èª¤:', error);
            }
        }

        // åˆå§‹åŒ–è™•æ–¹è¡¨æ ¼
        function initPrescriptionTable() {
            if (prescriptionHot) {
                prescriptionHot.destroy();
            }
            
            const container = document.getElementById('prescriptionTable');
            if (!container) return;
            
            prescriptionHot = new Handsontable(container, {
                data: [
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ],
                rowHeaders: true,
                colHeaders: ['è—¥ç‰©åç¨± *', 'åŠ‘é‡ *', 'ä½¿ç”¨é »ç‡ *', 'ä½¿ç”¨å¤©æ•¸ *', 'ç‰¹æ®ŠæŒ‡ç¤º'],
                columns: [
                    { 
                        type: 'text',
                        placeholder: 'ä¾‹ï¼šé˜¿æ–¯åŒ¹éˆ'
                    },
                    { 
                        type: 'text',
                        placeholder: 'ä¾‹ï¼š100mg'
                    },
                    { 
                        type: 'text',
                        placeholder: 'ä¾‹ï¼šæ¯æ—¥ä¸‰æ¬¡'
                    },
                    { 
                        type: 'text',
                        placeholder: 'ä¾‹ï¼š7å¤©'
                    },
                    { 
                        type: 'text',
                        placeholder: 'ä¾‹ï¼šé£¯å¾Œæœç”¨'
                    }
                ],
                minRows: 3,
                maxRows: 20,
                width: '100%',
                height: 300,
                licenseKey: 'non-commercial-and-evaluation',
                language: 'zh-TW',
                contextMenu: true,
                manualRowResize: true,
                manualColumnResize: true
            });
            
            console.log('è™•æ–¹è¡¨æ ¼å·²åˆå§‹åŒ–');
        }

        // æ–°å¢è™•æ–¹è—¥ç‰©åˆ—
        function addPrescriptionRow() {
            if (prescriptionHot) {
                prescriptionHot.alter('insert_row', prescriptionHot.countRows());
            }
        }

        // æ¸…ç©ºè¡¨å–®å‡½æ•¸
        function clearBasicForm() {
            document.getElementById('basicMedicineForm').reset();
        }

        function clearDetailedForm() {
            document.getElementById('detailedMedicineForm').reset();
        }

        function clearPrescriptionForm() {
            document.getElementById('prescriptionForm').reset();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
            if (prescriptionHot) {
                prescriptionHot.loadData([
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ]);
            }
        }
    </script>
</body>
</html> 