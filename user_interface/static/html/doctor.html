<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫生開立處方籤 - 醫院管理系統</title>

    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>

    <!--  -->
    <link rel="stylesheet" href="/css/unified_style.css">
    <script src="/js/doctor.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>系統選單</h2>
        <button onclick="location.href='doctor.html'" class="active">開立處方籤</button>
        <button onclick="location.href='Medicine.html'">藥物庫存管理</button>
        <button onclick="location.href='Prescription.html'">處方籤管理</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>醫生開立處方籤系統</h1>
            <p>醫生專用介面 - 開立處方籤和管理藥物資訊</p>
        </div>

        <div class="tab-container fade-in">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('basic')">基本藥物管理</button>
                <button class="tab-button" onclick="switchTab('detailed')">詳細藥物資訊</button>
                <button class="tab-button" onclick="switchTab('prescription')">開立處方籤</button>
            </div>

            <!--  -->
            <div id="basic" class="tab-content active">
                <div class="form-section">
                    <h3>新增基本藥物</h3>
                    <form id="basicMedicineForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="basicMedicineName" class="required">藥物名稱</label>
                                <input type="text" id="basicMedicineName" placeholder="請輸入藥物名稱" required>
                            </div>
                            <div class="form-group">
                                <label for="basicAmount" class="required">數量</label>
                                <input type="number" id="basicAmount" placeholder="請輸入數量" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="basicUsageDays" class="required">使用天數</label>
                                <input type="number" id="basicUsageDays" placeholder="請輸入使用天數" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="basicPosition" class="required">儲存位置</label>
                                <input type="text" id="basicPosition" placeholder="例如: A1-01, B2-15" required>
                            </div>
                        </div>
                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">新增藥物</button>
                            <button type="button" class="btn btn-warning" onclick="clearBasicForm()">清空表單</button>
                        </div>
                    </form>
                </div>

                <div id="basicMessage" class="message"></div>
            </div>

            <!--  -->
            <div id="detailed" class="tab-content">
                <div class="form-section">
                    <h3>詳細藥物資訊管理</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">為基本藥物添加詳細資訊，包括適應症、禁忌症、副作用等</p>

                    <form id="detailedMedicineForm">
                        <!--  -->
                        <div class="form-group">
                            <label for="detailedMedicineName" class="required">選擇藥物</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="detailedMedicineName" required style="flex: 1;">
                                    <option value="">--  --</option>
                                </select>
                                <button type="button" class="btn btn-info" onclick="loadMedicineOptions()">重新載入</button>
                            </div>
                        </div>

                        <!--  -->
                        <div class="form-section">
                            <h4>藥物詳細資訊 (可選)</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
                                以下資訊將以JSON格式儲存到詳細藥物資料庫中
                            </p>

                            <div class="form-group">
                                <label for="medicineDescription">藥物描述</label>
                                <textarea id="medicineDescription" rows="4"
                                    placeholder="請輸入藥物的詳細描述..."></textarea>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineManufacturer">製造商</label>
                                    <input type="text" id="medicineManufacturer" placeholder="請輸入製造商名稱">
                                </div>
                                <div class="form-group">
                                    <label for="medicineDosage">劑量</label>
                                    <input type="text" id="medicineDosage" placeholder="例如: 10mg, 500mg">
                                </div>
                                <div class="form-group">
                                    <label for="medicineColor">顏色</label>
                                    <input type="text" id="medicineColor" placeholder="請輸入藥物顏色">
                                </div>
                                <div class="form-group">
                                    <label for="medicineShape">形狀</label>
                                    <input type="text" id="medicineShape" placeholder="請輸入藥物形狀">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="medicineSideEffects">副作用</label>
                                <textarea id="medicineSideEffects" rows="3"
                                    placeholder="請輸入可能的副作用..."></textarea>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineStorage">儲存條件</label>
                                    <input type="text" id="medicineStorage" placeholder="請輸入儲存條件">
                                </div>
                                <div class="form-group">
                                    <label for="medicineExpiry">有效期限</label>
                                    <input type="date" id="medicineExpiry">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="medicineNotes">備註</label>
                                <textarea id="medicineNotes" rows="3"
                                    placeholder="請輸入其他備註資訊..."></textarea>
                            </div>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">儲存詳細資訊</button>
                            <button type="button" class="btn btn-warning" onclick="clearDetailedForm()">清空表單</button>
                        </div>
                    </form>
                </div>

                <div id="detailedMessage" class="message"></div>
            </div>

            <!--  -->
            <div id="prescription" class="tab-content">
                <div class="form-section">
                    <h3>開立處方籤</h3>
                    <form id="prescriptionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="patientName" class="required">患者姓名</label>
                                <input type="text" id="patientName" placeholder="請輸入患者姓名" required>
                            </div>
                            <div class="form-group">
                                <label for="patientId">患者編號</label>
                                <input type="text" id="patientId" placeholder="請輸入患者編號">
                            </div>
                            <div class="form-group">
                                <label for="doctorName" class="required">醫生姓名</label>
                                <input type="text" id="doctorName" placeholder="請輸入醫生姓名" required>
                            </div>
                            <div class="form-group">
                                <label for="prescriptionDate">處方日期</label>
                                <input type="date" id="prescriptionDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="diagnosis">診斷結果</label>
                            <textarea id="diagnosis" rows="3" placeholder="請輸入診斷結果..."></textarea>
                        </div>

                        <div class="form-section">
                            <h4>處方用藥</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">
                                請在下方表格中填入處方用藥資訊，標記 * 的欄位為必填
                            </p>
                            <div id="prescriptionTable" class="hot-container"></div>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success">開立處方籤</button>
                            <button type="button" class="btn btn-warning" onclick="clearPrescriptionForm()">清空表單</button>
                            <button type="button" class="btn btn-info" onclick="addPrescriptionRow()">新增藥物行</button>
                        </div>
                    </form>
                </div>

                <div id="prescriptionMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // APIURL
        const API_BASE = 'http://localhost:8000';

        //
        let prescriptionHot = null;

        //
        document.addEventListener('DOMContentLoaded', () => {
            loadMedicineOptions();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
        });

        // 標籤頁切換功能
        function switchTab(tabName) {
            // 隱藏所有標籤頁內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 移除所有按鈕的 active 狀態
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // 顯示選中的標籤頁
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 設置按鈕為 active 狀態
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // 如果沒有事件對象，找到對應的按鈕
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach((button, index) => {
                    if ((tabName === 'basic' && index === 0) ||
                        (tabName === 'detailed' && index === 1) ||
                        (tabName === 'prescription' && index === 2)) {
                        button.classList.add('active');
                    }
                });
            }

            // 處方籤標籤頁需要初始化表格
            if (tabName === 'prescription') {
                setTimeout(() => initPrescriptionTable(), 100);
            }
            
            console.log('切換到標籤頁:', tabName);
        }

        //
        function showMessage(elementId, message, type = 'success') {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        //
        document.getElementById('basicMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('basicMedicineName').value.trim(),
                amount: parseInt(document.getElementById('basicAmount').value),
                usage_days: parseInt(document.getElementById('basicUsageDays').value),
                position: document.getElementById('basicPosition').value.trim()
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('basicMessage', ` ID: ${result.id}`, 'success');
                    clearBasicForm();
                    loadMedicineOptions(); //
                } else {
                    const error = await response.json();
                    showMessage('basicMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('basicMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        document.getElementById('detailedMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const medicineName = document.getElementById('detailedMedicineName').value;
            if (!medicineName) {
                showMessage('detailedMessage', ' ', 'error');
                return;
            }

            // 組織詳細藥物資訊數據
            const medicineData = {
                basic_info: {
                    name: medicineName,
                    manufacturer: document.getElementById('medicineManufacturer').value || '',
                    dosage: document.getElementById('medicineDosage').value || ''
                },
                appearance: {
                    color: document.getElementById('medicineColor').value || '',
                    shape: document.getElementById('medicineShape').value || ''
                },
                description: document.getElementById('medicineDescription').value || '',
                side_effects: document.getElementById('medicineSideEffects').value || '',
                storage_conditions: document.getElementById('medicineStorage').value || '',
                expiry_date: document.getElementById('medicineExpiry').value || '',
                notes: document.getElementById('medicineNotes').value || '',
                created_time: new Date().toISOString(),
                created_by: document.getElementById('doctorName')?.value || ''
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        medicine_name: medicineName,
                        medicine_data: medicineData
                    })
                });

                if (response.ok) {
                    showMessage('detailedMessage', ` `, 'success');
                    clearDetailedForm();
                } else {
                    const error = await response.json();
                    showMessage('detailedMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('detailedMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!prescriptionHot) {
                showMessage('prescriptionMessage', ' ', 'error');
                return;
            }

            const tableData = prescriptionHot.getData();
            const medicines = tableData.filter(row =>
                row[0] && row[0].trim() && row[1] && row[1].trim() && row[2] && row[2].trim() && row[3] && row[3].trim()
            ).map(row => ({
                medicine_name: row[0].trim(),
                dosage: row[1].trim(),
                frequency: row[2].trim(),
                duration: row[3].trim(),
                instructions: row[4] ? row[4].trim() : ''
            }));

            if (medicines.length === 0) {
                showMessage('prescriptionMessage', ' ', 'error');
                return;
            }

            const prescriptionData = {
                patient_name: document.getElementById('patientName').value.trim(),
                doctor_name: document.getElementById('doctorName').value.trim(),
                diagnosis: document.getElementById('diagnosis').value.trim(),
                medicines: medicines,
                prescription_date: document.getElementById('prescriptionDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/prescription/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(prescriptionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('prescriptionMessage', ` : ${result.id}`, 'success');
                    clearPrescriptionForm();
                } else {
                    const error = await response.json();
                    showMessage('prescriptionMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('prescriptionMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        async function loadMedicineOptions() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/`);
                if (response.ok) {
                    const medicines = await response.json();
                    const select = document.getElementById('detailedMedicineName');

                    //
                    select.innerHTML = '<option value="">--  --</option>';

                    //
                    medicines.forEach(medicine => {
                        const option = document.createElement('option');
                        option.value = medicine.name;
                        option.textContent = `${medicine.name} (: ${medicine.position}, : ${medicine.amount})`;
                        select.appendChild(option);
                    });

                    console.log(` ${medicines.length} `);
                } else {
                    console.error(':', response.status);
                }
            } catch (error) {
                console.error(':', error);
            }
        }

        //
        function initPrescriptionTable() {
            if (prescriptionHot) {
                prescriptionHot.destroy();
            }

            const container = document.getElementById('prescriptionTable');
            if (!container) return;

            prescriptionHot = new Handsontable(container, {
                data: [
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ],
                rowHeaders: true,
                colHeaders: ['藥物名稱 *', '劑量 *', '頻率 *', '療程 *', '特殊說明'],
                columns: [
                    {
                        type: 'text',
                        placeholder: '請輸入藥物名稱'
                    },
                    {
                        type: 'text',
                        placeholder: '例如: 100mg'
                    },
                    {
                        type: 'text',
                        placeholder: '例如: 每日三次'
                    },
                    {
                        type: 'text',
                        placeholder: '例如: 7天'
                    },
                    {
                        type: 'text',
                        placeholder: '特殊用藥說明'
                    }
                ],
                minRows: 3,
                maxRows: 20,
                width: '100%',
                height: 300,
                licenseKey: 'non-commercial-and-evaluation',
                language: 'zh-TW',
                contextMenu: true,
                manualRowResize: true,
                manualColumnResize: true
            });

            console.log('');
        }

        //
        function addPrescriptionRow() {
            if (prescriptionHot) {
                prescriptionHot.alter('insert_row', prescriptionHot.countRows());
            }
        }

        //
        function clearBasicForm() {
            document.getElementById('basicMedicineForm').reset();
        }

        function clearDetailedForm() {
            document.getElementById('detailedMedicineForm').reset();
        }

        function clearPrescriptionForm() {
            document.getElementById('prescriptionForm').reset();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
            if (prescriptionHot) {
                prescriptionHot.loadData([
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ]);
            }
        }
    </script>
</body>
</html>