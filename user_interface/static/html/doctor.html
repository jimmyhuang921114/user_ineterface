<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> - </title>

    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>

    <!--  -->
    <link rel="stylesheet" href="/css/unified_style.css">
</head>
<body>
    <div class="sidebar">
        <h2></h2>
        <button onclick="location.href='doctor.html'" class="active"></button>
        <button onclick="location.href='Medicine.html'"></button>
        <button onclick="location.href='Prescription.html'"></button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1></h1>
            <p> - </p>
        </div>

        <div class="tab-container fade-in">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('basic')"></button>
                <button class="tab-button" onclick="switchTab('detailed')"></button>
                <button class="tab-button" onclick="switchTab('prescription')"></button>
            </div>

            <!--  -->
            <div id="basic" class="tab-content active">
                <div class="form-section">
                    <h3></h3>
                    <form id="basicMedicineForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="basicMedicineName" class="required"></label>
                                <input type="text" id="basicMedicineName" placeholder="" required>
                            </div>
                            <div class="form-group">
                                <label for="basicAmount" class="required"></label>
                                <input type="number" id="basicAmount" placeholder="" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="basicUsageDays" class="required"></label>
                                <input type="number" id="basicUsageDays" placeholder="" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="basicPosition" class="required"></label>
                                <input type="text" id="basicPosition" placeholder="A1-01, B2-15" required>
                            </div>
                        </div>
                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success"> </button>
                            <button type="button" class="btn btn-warning" onclick="clearBasicForm()"> </button>
                        </div>
                    </form>
                </div>

                <div id="basicMessage" class="message"></div>
            </div>

            <!--  -->
            <div id="detailed" class="tab-content">
                <div class="form-section">
                    <h3></h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;"></p>

                    <form id="detailedMedicineForm">
                        <!--  -->
                        <div class="form-group">
                            <label for="detailedMedicineName" class="required"></label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="detailedMedicineName" required style="flex: 1;">
                                    <option value="">--  --</option>
                                </select>
                                <button type="button" class="btn btn-info" onclick="loadMedicineOptions()"> </button>
                            </div>
                        </div>

                        <!--  -->
                        <div class="form-section">
                            <h4>  ()</h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
                                JSON
                            </p>

                            <div class="form-group">
                                <label for="medicineDescription"> </label>
                                <textarea id="medicineDescription" rows="4"
                                    placeholder="..."></textarea>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineManufacturer"> </label>
                                    <input type="text" id="medicineManufacturer" placeholder="">
                                </div>
                                <div class="form-group">
                                    <label for="medicineDosage"> </label>
                                    <input type="text" id="medicineDosage" placeholder="10mg, 500mg">
                                </div>
                                <div class="form-group">
                                    <label for="medicineColor"> </label>
                                    <input type="text" id="medicineColor" placeholder="">
                                </div>
                                <div class="form-group">
                                    <label for="medicineShape"> </label>
                                    <input type="text" id="medicineShape" placeholder="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="medicineSideEffects"> </label>
                                <textarea id="medicineSideEffects" rows="3"
                                    placeholder="..."></textarea>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="medicineStorage"> </label>
                                    <input type="text" id="medicineStorage" placeholder="">
                                </div>
                                <div class="form-group">
                                    <label for="medicineExpiry"> </label>
                                    <input type="date" id="medicineExpiry">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="medicineNotes"> </label>
                                <textarea id="medicineNotes" rows="3"
                                    placeholder="..."></textarea>
                            </div>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success"> </button>
                            <button type="button" class="btn btn-warning" onclick="clearDetailedForm()"> </button>
                        </div>
                    </form>
                </div>

                <div id="detailedMessage" class="message"></div>
            </div>

            <!--  -->
            <div id="prescription" class="tab-content">
                <div class="form-section">
                    <h3></h3>
                    <form id="prescriptionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="patientName" class="required"></label>
                                <input type="text" id="patientName" placeholder="" required>
                            </div>
                            <div class="form-group">
                                <label for="patientId"></label>
                                <input type="text" id="patientId" placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="doctorName" class="required"></label>
                                <input type="text" id="doctorName" placeholder="" required>
                            </div>
                            <div class="form-group">
                                <label for="prescriptionDate"></label>
                                <input type="date" id="prescriptionDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="diagnosis"> </label>
                            <textarea id="diagnosis" rows="3" placeholder="..."></textarea>
                        </div>

                        <div class="form-section">
                            <h4> </h4>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">

                            </p>
                            <div id="prescriptionTable" class="hot-container"></div>
                        </div>

                        <div style="margin-top: 25px;">
                            <button type="submit" class="btn btn-success"> </button>
                            <button type="button" class="btn btn-warning" onclick="clearPrescriptionForm()"> </button>
                            <button type="button" class="btn btn-info" onclick="addPrescriptionRow()"> </button>
                        </div>
                    </form>
                </div>

                <div id="prescriptionMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // APIURL
        const API_BASE = 'http://localhost:8000';

        //
        let prescriptionHot = null;

        //
        document.addEventListener('DOMContentLoaded', () => {
            loadMedicineOptions();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
        });

        //
        function switchTab(tabName) {
            //
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // active
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            //
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            //
            if (tabName === 'prescription') {
                setTimeout(() => initPrescriptionTable(), 100);
            }
        }

        //
        function showMessage(elementId, message, type = 'success') {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        //
        document.getElementById('basicMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('basicMedicineName').value.trim(),
                amount: parseInt(document.getElementById('basicAmount').value),
                usage_days: parseInt(document.getElementById('basicUsageDays').value),
                position: document.getElementById('basicPosition').value.trim()
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('basicMessage', ` ID: ${result.id}`, 'success');
                    clearBasicForm();
                    loadMedicineOptions(); //
                } else {
                    const error = await response.json();
                    showMessage('basicMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('basicMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        document.getElementById('detailedMedicineForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const medicineName = document.getElementById('detailedMedicineName').value;
            if (!medicineName) {
                showMessage('detailedMessage', ' ', 'error');
                return;
            }

            //
            const medicineData = {
                : {
                    : medicineName,
                    : document.getElementById('medicineManufacturer').value || '',
                    : document.getElementById('medicineDosage').value || ''
                },
                : {
                    : document.getElementById('medicineColor').value || '',
                    : document.getElementById('medicineShape').value || ''
                },
                : document.getElementById('medicineDescription').value || '',
                : document.getElementById('medicineSideEffects').value || '',
                : document.getElementById('medicineStorage').value || '',
                : document.getElementById('medicineExpiry').value || '',
                : document.getElementById('medicineNotes').value || '',
                : new Date().toISOString(),
                : document.getElementById('doctorName')?.value || ''
            };

            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        medicine_name: medicineName,
                        medicine_data: medicineData
                    })
                });

                if (response.ok) {
                    showMessage('detailedMessage', ` `, 'success');
                    clearDetailedForm();
                } else {
                    const error = await response.json();
                    showMessage('detailedMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('detailedMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!prescriptionHot) {
                showMessage('prescriptionMessage', ' ', 'error');
                return;
            }

            const tableData = prescriptionHot.getData();
            const medicines = tableData.filter(row =>
                row[0] && row[0].trim() && row[1] && row[1].trim() && row[2] && row[2].trim() && row[3] && row[3].trim()
            ).map(row => ({
                medicine_name: row[0].trim(),
                dosage: row[1].trim(),
                frequency: row[2].trim(),
                duration: row[3].trim(),
                instructions: row[4] ? row[4].trim() : ''
            }));

            if (medicines.length === 0) {
                showMessage('prescriptionMessage', ' ', 'error');
                return;
            }

            const prescriptionData = {
                patient_name: document.getElementById('patientName').value.trim(),
                doctor_name: document.getElementById('doctorName').value.trim(),
                diagnosis: document.getElementById('diagnosis').value.trim(),
                medicines: medicines,
                prescription_date: document.getElementById('prescriptionDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/prescription/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(prescriptionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('prescriptionMessage', ` : ${result.id}`, 'success');
                    clearPrescriptionForm();
                } else {
                    const error = await response.json();
                    showMessage('prescriptionMessage', ` : ${error.detail || ''}`, 'error');
                }
            } catch (error) {
                showMessage('prescriptionMessage', ` : ${error.message}`, 'error');
            }
        });

        //
        async function loadMedicineOptions() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/`);
                if (response.ok) {
                    const medicines = await response.json();
                    const select = document.getElementById('detailedMedicineName');

                    //
                    select.innerHTML = '<option value="">--  --</option>';

                    //
                    medicines.forEach(medicine => {
                        const option = document.createElement('option');
                        option.value = medicine.name;
                        option.textContent = `${medicine.name} (: ${medicine.position}, : ${medicine.amount})`;
                        select.appendChild(option);
                    });

                    console.log(` ${medicines.length} `);
                } else {
                    console.error(':', response.status);
                }
            } catch (error) {
                console.error(':', error);
            }
        }

        //
        function initPrescriptionTable() {
            if (prescriptionHot) {
                prescriptionHot.destroy();
            }

            const container = document.getElementById('prescriptionTable');
            if (!container) return;

            prescriptionHot = new Handsontable(container, {
                data: [
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ],
                rowHeaders: true,
                colHeaders: [' *', ' *', ' *', ' *', ''],
                columns: [
                    {
                        type: 'text',
                        placeholder: ''
                    },
                    {
                        type: 'text',
                        placeholder: '100mg'
                    },
                    {
                        type: 'text',
                        placeholder: ''
                    },
                    {
                        type: 'text',
                        placeholder: '7'
                    },
                    {
                        type: 'text',
                        placeholder: ''
                    }
                ],
                minRows: 3,
                maxRows: 20,
                width: '100%',
                height: 300,
                licenseKey: 'non-commercial-and-evaluation',
                language: 'zh-TW',
                contextMenu: true,
                manualRowResize: true,
                manualColumnResize: true
            });

            console.log('');
        }

        //
        function addPrescriptionRow() {
            if (prescriptionHot) {
                prescriptionHot.alter('insert_row', prescriptionHot.countRows());
            }
        }

        //
        function clearBasicForm() {
            document.getElementById('basicMedicineForm').reset();
        }

        function clearDetailedForm() {
            document.getElementById('detailedMedicineForm').reset();
        }

        function clearPrescriptionForm() {
            document.getElementById('prescriptionForm').reset();
            document.getElementById('prescriptionDate').value = new Date().toISOString().split('T')[0];
            if (prescriptionHot) {
                prescriptionHot.loadData([
                    ['', '', '', '', ''],
                    ['', '', '', '', ''],
                    ['', '', '', '', '']
                ]);
            }
        }
    </script>
</body>
</html>