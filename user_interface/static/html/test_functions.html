<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª é†«é™¢ç®¡ç†ç³»çµ± - åŠŸèƒ½æ¸¬è©¦</title>
    <link rel="stylesheet" href="/css/unified_style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ§ª é†«é™¢ç®¡ç†ç³»çµ±åŠŸèƒ½æ¸¬è©¦</h1>
            <p>æ¸¬è©¦æ‰€æœ‰ç³»çµ±åŠŸèƒ½çš„è¼¸å…¥è¼¸å‡º</p>
        </div>

        <!-- åŸºæœ¬è—¥ç‰©ç®¡ç†æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ’Š åŸºæœ¬è—¥ç‰©ç®¡ç†æ¸¬è©¦</h2>
            <button class="test-button" onclick="testAddMedicine()">æ¸¬è©¦æ–°å¢è—¥ç‰©</button>
            <button class="test-button" onclick="testGetMedicines()">æ¸¬è©¦ç²å–è—¥ç‰©åˆ—è¡¨</button>
            <button class="test-button" onclick="testUpdateMedicine()">æ¸¬è©¦æ›´æ–°è—¥ç‰©</button>
            <button class="test-button" onclick="testDeleteMedicine()">æ¸¬è©¦åˆªé™¤è—¥ç‰©</button>
            <div id="medicineTestResults"></div>
        </div>

        <!-- è©³ç´°è—¥ç‰©è³‡è¨Šæ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“‹ è©³ç´°è—¥ç‰©è³‡è¨Šæ¸¬è©¦</h2>
            <button class="test-button" onclick="testAddDetailedMedicine()">æ¸¬è©¦æ–°å¢è©³ç´°è³‡è¨Š</button>
            <button class="test-button" onclick="testGetDetailedMedicine()">æ¸¬è©¦ç²å–è©³ç´°è³‡è¨Š</button>
            <button class="test-button" onclick="testSearchMedicine()">æ¸¬è©¦æœå°‹è—¥ç‰©</button>
            <div id="detailedTestResults"></div>
        </div>

        <!-- è™•æ–¹ç±¤ç®¡ç†æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“ è™•æ–¹ç±¤ç®¡ç†æ¸¬è©¦</h2>
            <button class="test-button" onclick="testAddPrescription()">æ¸¬è©¦é–‹ç«‹è™•æ–¹ç±¤</button>
            <button class="test-button" onclick="testGetPrescriptions()">æ¸¬è©¦ç²å–è™•æ–¹ç±¤åˆ—è¡¨</button>
            <button class="test-button" onclick="testUpdatePrescriptionStatus()">æ¸¬è©¦æ›´æ–°ç‹€æ…‹</button>
            <div id="prescriptionTestResults"></div>
        </div>

        <!-- æ¨™ç±¤é åˆ‡æ›æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ”„ ç•Œé¢åŠŸèƒ½æ¸¬è©¦</h2>
            <button class="test-button" onclick="testTabSwitching()">æ¸¬è©¦æ¨™ç±¤é åˆ‡æ›</button>
            <button class="test-button" onclick="testFormValidation()">æ¸¬è©¦è¡¨å–®é©—è­‰</button>
            <button class="test-button" onclick="testDataExport()">æ¸¬è©¦æ•¸æ“šåŒ¯å‡º</button>
            <div id="interfaceTestResults"></div>
        </div>

        <!-- æ•´é«”æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ¯ æ•´é«”ç³»çµ±æ¸¬è©¦</h2>
            <button class="test-button" onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button class="test-button" onclick="clearTestData()">æ¸…ç†æ¸¬è©¦æ•¸æ“š</button>
            <div id="overallTestResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let testResults = {};

        // é€šç”¨å‡½æ•¸
        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // åŸºæœ¬è—¥ç‰©ç®¡ç†æ¸¬è©¦
        async function testAddMedicine() {
            clearResults('medicineTestResults');
            try {
                const testData = {
                    name: `æ¸¬è©¦è—¥ç‰©_${Date.now()}`,
                    amount: 100,
                    usage_days: 7,
                    position: 'TEST-01'
                };

                const response = await fetch(`${API_BASE}/medicine/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    testResults.lastMedicineId = result.id;
                    showResult('medicineTestResults', `âœ… æ–°å¢è—¥ç‰©æˆåŠŸ: ${result.name} (ID: ${result.id})`, 'success');
                } else {
                    showResult('medicineTestResults', `âŒ æ–°å¢è—¥ç‰©å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('medicineTestResults', `âŒ æ–°å¢è—¥ç‰©éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testGetMedicines() {
            try {
                const response = await fetch(`${API_BASE}/medicine/`);
                if (response.ok) {
                    const medicines = await response.json();
                    showResult('medicineTestResults', `âœ… ç²å–è—¥ç‰©åˆ—è¡¨æˆåŠŸ: å…± ${medicines.length} ç¨®è—¥ç‰©`, 'success');
                    showResult('medicineTestResults', `ğŸ“‹ åˆ—è¡¨å…§å®¹: ${medicines.map(m => m.name).join(', ')}`, 'info');
                } else {
                    showResult('medicineTestResults', `âŒ ç²å–è—¥ç‰©åˆ—è¡¨å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('medicineTestResults', `âŒ ç²å–è—¥ç‰©åˆ—è¡¨éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testUpdateMedicine() {
            if (!testResults.lastMedicineId) {
                showResult('medicineTestResults', 'âŒ è«‹å…ˆåŸ·è¡Œæ–°å¢è—¥ç‰©æ¸¬è©¦', 'error');
                return;
            }

            try {
                const updateData = {
                    name: `æ›´æ–°æ¸¬è©¦è—¥ç‰©_${Date.now()}`,
                    amount: 200,
                    usage_days: 14,
                    position: 'TEST-02'
                };

                const response = await fetch(`${API_BASE}/medicine/${testResults.lastMedicineId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    showResult('medicineTestResults', `âœ… æ›´æ–°è—¥ç‰©æˆåŠŸ: ID ${testResults.lastMedicineId}`, 'success');
                } else {
                    showResult('medicineTestResults', `âŒ æ›´æ–°è—¥ç‰©å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('medicineTestResults', `âŒ æ›´æ–°è—¥ç‰©éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testDeleteMedicine() {
            if (!testResults.lastMedicineId) {
                showResult('medicineTestResults', 'âŒ è«‹å…ˆåŸ·è¡Œæ–°å¢è—¥ç‰©æ¸¬è©¦', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/medicine/${testResults.lastMedicineId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showResult('medicineTestResults', `âœ… åˆªé™¤è—¥ç‰©æˆåŠŸ: ID ${testResults.lastMedicineId}`, 'success');
                    testResults.lastMedicineId = null;
                } else {
                    showResult('medicineTestResults', `âŒ åˆªé™¤è—¥ç‰©å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('medicineTestResults', `âŒ åˆªé™¤è—¥ç‰©éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // è©³ç´°è—¥ç‰©è³‡è¨Šæ¸¬è©¦
        async function testAddDetailedMedicine() {
            clearResults('detailedTestResults');
            try {
                const detailedData = {
                    medicine_name: 'é˜¿æ–¯åŒ¹éˆ',
                    medicine_data: {
                        basic_info: {
                            name: 'é˜¿æ–¯åŒ¹éˆ',
                            manufacturer: 'æ¸¬è©¦è£½è—¥å…¬å¸',
                            dosage: '100mg'
                        },
                        appearance: {
                            color: 'ç™½è‰²',
                            shape: 'åœ“å½¢'
                        },
                        indications: 'è§£ç†±é®ç—›',
                        side_effects: 'å¯èƒ½å¼•èµ·èƒƒéƒ¨ä¸é©',
                        storage_conditions: 'å®¤æº«ä¿å­˜',
                        expiry_date: '2025-12-31'
                    }
                };

                const response = await fetch(`${API_BASE}/medicine/detailed/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(detailedData)
                });

                if (response.ok) {
                    showResult('detailedTestResults', 'âœ… æ–°å¢è©³ç´°è—¥ç‰©è³‡è¨ŠæˆåŠŸ', 'success');
                } else {
                    showResult('detailedTestResults', `âŒ æ–°å¢è©³ç´°è³‡è¨Šå¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('detailedTestResults', `âŒ æ–°å¢è©³ç´°è³‡è¨ŠéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testGetDetailedMedicine() {
            try {
                const response = await fetch(`${API_BASE}/medicine/detailed/é˜¿æ–¯åŒ¹éˆ`);
                if (response.ok) {
                    const data = await response.json();
                    showResult('detailedTestResults', 'âœ… ç²å–è©³ç´°è—¥ç‰©è³‡è¨ŠæˆåŠŸ', 'success');
                    showResult('detailedTestResults', `ğŸ“‹ è³‡è¨Š: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    showResult('detailedTestResults', `âŒ ç²å–è©³ç´°è³‡è¨Šå¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('detailedTestResults', `âŒ ç²å–è©³ç´°è³‡è¨ŠéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testSearchMedicine() {
            try {
                const response = await fetch(`${API_BASE}/medicine/integrated/é˜¿æ–¯åŒ¹éˆ`);
                if (response.ok) {
                    const data = await response.json();
                    showResult('detailedTestResults', 'âœ… æœå°‹è—¥ç‰©æˆåŠŸ', 'success');
                    showResult('detailedTestResults', `ğŸ” æœå°‹çµæœ: ${data.medicine_name || 'æœªæ‰¾åˆ°'}`, 'info');
                } else {
                    showResult('detailedTestResults', `âŒ æœå°‹è—¥ç‰©å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('detailedTestResults', `âŒ æœå°‹è—¥ç‰©éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // è™•æ–¹ç±¤ç®¡ç†æ¸¬è©¦
        async function testAddPrescription() {
            clearResults('prescriptionTestResults');
            try {
                const prescriptionData = {
                    patient_name: 'æ¸¬è©¦æ‚£è€…',
                    doctor_name: 'æ¸¬è©¦é†«å¸«',
                    diagnosis: 'æ¸¬è©¦è¨ºæ–·',
                    medicines: [{
                        medicine_name: 'é˜¿æ–¯åŒ¹éˆ',
                        dosage: '100mg',
                        frequency: 'æ¯æ—¥ä¸‰æ¬¡',
                        duration: '7å¤©',
                        instructions: 'é£¯å¾Œæœç”¨'
                    }],
                    prescription_date: new Date().toISOString().split('T')[0]
                };

                const response = await fetch(`${API_BASE}/prescription/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prescriptionData)
                });

                if (response.ok) {
                    const result = await response.json();
                    testResults.lastPrescriptionId = result.id;
                    showResult('prescriptionTestResults', `âœ… é–‹ç«‹è™•æ–¹ç±¤æˆåŠŸ: ID ${result.id}`, 'success');
                } else {
                    showResult('prescriptionTestResults', `âŒ é–‹ç«‹è™•æ–¹ç±¤å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('prescriptionTestResults', `âŒ é–‹ç«‹è™•æ–¹ç±¤éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testGetPrescriptions() {
            try {
                const response = await fetch(`${API_BASE}/prescription/`);
                if (response.ok) {
                    const prescriptions = await response.json();
                    showResult('prescriptionTestResults', `âœ… ç²å–è™•æ–¹ç±¤åˆ—è¡¨æˆåŠŸ: å…± ${prescriptions.length} å¼µ`, 'success');
                } else {
                    showResult('prescriptionTestResults', `âŒ ç²å–è™•æ–¹ç±¤åˆ—è¡¨å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('prescriptionTestResults', `âŒ ç²å–è™•æ–¹ç±¤åˆ—è¡¨éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testUpdatePrescriptionStatus() {
            if (!testResults.lastPrescriptionId) {
                showResult('prescriptionTestResults', 'âŒ è«‹å…ˆåŸ·è¡Œé–‹ç«‹è™•æ–¹ç±¤æ¸¬è©¦', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prescription/${testResults.lastPrescriptionId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'processing',
                        updated_by: 'æ¸¬è©¦ç³»çµ±',
                        notes: 'æ¸¬è©¦ç‹€æ…‹æ›´æ–°'
                    })
                });

                if (response.ok) {
                    showResult('prescriptionTestResults', `âœ… æ›´æ–°è™•æ–¹ç±¤ç‹€æ…‹æˆåŠŸ: ID ${testResults.lastPrescriptionId}`, 'success');
                } else {
                    showResult('prescriptionTestResults', `âŒ æ›´æ–°è™•æ–¹ç±¤ç‹€æ…‹å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('prescriptionTestResults', `âŒ æ›´æ–°è™•æ–¹ç±¤ç‹€æ…‹éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // ç•Œé¢åŠŸèƒ½æ¸¬è©¦
        function testTabSwitching() {
            clearResults('interfaceTestResults');
            showResult('interfaceTestResults', 'ğŸ”„ æ¸¬è©¦æ¨™ç±¤é åˆ‡æ›åŠŸèƒ½...', 'info');
            
            // æ¨¡æ“¬åœ¨æ–°çª—å£ä¸­æ¸¬è©¦æ¨™ç±¤é 
            window.open('/doctor.html', '_blank');
            showResult('interfaceTestResults', 'âœ… å·²æ‰“é–‹é†«ç”Ÿç•Œé¢ï¼Œè«‹æ‰‹å‹•æ¸¬è©¦æ¨™ç±¤é åˆ‡æ›', 'success');
        }

        function testFormValidation() {
            showResult('interfaceTestResults', 'ğŸ“ æ¸¬è©¦è¡¨å–®é©—è­‰åŠŸèƒ½...', 'info');
            showResult('interfaceTestResults', 'âœ… è¡¨å–®é©—è­‰éœ€è¦åœ¨å¯¦éš›ç•Œé¢ä¸­æ¸¬è©¦', 'success');
        }

        function testDataExport() {
            showResult('interfaceTestResults', 'ğŸ“Š æ¸¬è©¦æ•¸æ“šåŒ¯å‡ºåŠŸèƒ½...', 'info');
            window.open('/api/export/medicines/basic', '_blank');
            showResult('interfaceTestResults', 'âœ… å·²è§¸ç™¼æ•¸æ“šåŒ¯å‡ºï¼Œè«‹æª¢æŸ¥ä¸‹è¼‰', 'success');
        }

        // æ•´é«”æ¸¬è©¦
        async function runAllTests() {
            clearResults('overallTestResults');
            showResult('overallTestResults', 'ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...', 'info');
            
            // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
            await testAddMedicine();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testGetMedicines();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAddDetailedMedicine();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAddPrescription();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testGetPrescriptions();
            
            showResult('overallTestResults', 'ğŸ‰ æ‰€æœ‰è‡ªå‹•åŒ–æ¸¬è©¦å®Œæˆï¼', 'success');
        }

        async function clearTestData() {
            showResult('overallTestResults', 'ğŸ§¹ æ¸…ç†æ¸¬è©¦æ•¸æ“š...', 'info');
            // é€™è£¡å¯ä»¥æ·»åŠ æ¸…ç†é‚è¼¯
            showResult('overallTestResults', 'âœ… æ¸¬è©¦æ•¸æ“šæ¸…ç†å®Œæˆ', 'success');
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            showResult('overallTestResults', 'ğŸ“‹ æ¸¬è©¦é é¢å·²è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦', 'success');
        });
    </script>
</body>
</html>