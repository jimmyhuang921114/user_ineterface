<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—¥ç‰©åº«å­˜ç®¡ç† - é†«é™¢ç®¡ç†ç³»çµ±</title>
    
    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>
    
    <!-- çµ±ä¸€é¢¨æ ¼ -->
    <link rel="stylesheet" href="../css/unified_style.css">
</head>
<body>
    <div class="sidebar">
        <h2>é†«é™¢ç®¡ç†ç³»çµ±</h2>
        <button onclick="location.href='doctor.html'">é†«ç”Ÿå·¥ä½œå°</button>
        <button onclick="location.href='Medicine.html'" class="active">è—¥ç‰©åº«å­˜ç®¡ç†</button>
        <button onclick="location.href='Prescription.html'">è™•æ–¹ç®¡ç†ç³»çµ±</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>è—¥ç‰©åº«å­˜ç®¡ç†</h1>
            <p>æŸ¥çœ‹åŸºæœ¬åº«å­˜èˆ‡è©³ç´°è—¥ç‰©è³‡è¨Š - æ‰€æœ‰é†«ç”Ÿå¡«å¯«çš„è³‡æ–™éƒ½æœƒåœ¨é€™è£¡é¡¯ç¤º</p>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>ğŸ“Š åº«å­˜çµ±è¨ˆ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="totalMedicines">0</div>
                        <div style="color: #7f8c8d;">åŸºæœ¬è—¥ç‰©</div>
                    </div>
                    <div style="padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="detailedMedicines">0</div>
                        <div style="color: #7f8c8d;">è©³ç´°è³‡è¨Š</div>
                    </div>
                    <div style="padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="lowStock">0</div>
                        <div style="color: #7f8c8d;">åº«å­˜ä¸è¶³</div>
                    </div>
                    <div style="padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9b59b6;" id="totalStock">0</div>
                        <div style="color: #7f8c8d;">ç¸½åº«å­˜é‡</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŸºæœ¬åº«å­˜ç®¡ç† -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ“¦ åŸºæœ¬åº«å­˜æ¸…å–®</h3>
                    <div>
                        <button class="btn btn-info" onclick="loadBasicMedicines()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                        <button class="btn btn-success" onclick="exportBasicData()">ğŸ“Š åŒ¯å‡ºè³‡æ–™</button>
                    </div>
                </div>
                <div id="basicMedicineTable" class="hot-container"></div>
            </div>
        </div>

        <!-- è©³ç´°è—¥ç‰©è³‡è¨ŠæŸ¥çœ‹ -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>ğŸ” è©³ç´°è—¥ç‰©è³‡è¨ŠæŸ¥è©¢</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    æŸ¥çœ‹é†«ç”Ÿåœ¨å·¥ä½œå°å¡«å¯«çš„è©³ç´°è—¥ç‰©è³‡è¨Šï¼ŒåŒ…æ‹¬é©æ‡‰ç—‡ã€å‰¯ä½œç”¨ã€ä½¿ç”¨èªªæ˜ç­‰
                </p>
                
                <!-- æœå°‹æ§åˆ¶å€ -->
                <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 25px; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                        <label for="searchInput">ğŸ” æœå°‹è—¥ç‰©</label>
                        <input type="text" id="searchInput" placeholder="è¼¸å…¥è—¥ç‰©åç¨±..." style="width: 100%;">
                    </div>
                    <button class="btn btn-primary" onclick="searchMedicine()">æœå°‹</button>
                    <button class="btn btn-info" onclick="searchByCode()">æŒ‰ç·¨è™Ÿæœå°‹</button>
                    <button class="btn btn-success" onclick="loadAllDetailed()">é¡¯ç¤ºå…¨éƒ¨</button>
                </div>

                <!-- æœå°‹çµæœå€åŸŸ -->
                <div id="searchResults" style="display: none;">
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
                        <h4 style="margin: 0; color: #3498db;">ğŸ¯ æœå°‹çµæœ</h4>
                        <p style="margin: 5px 0 0 0; color: #7f8c8d;" id="searchStatus">æ‰¾åˆ° 0 å€‹çµæœ</p>
                    </div>
                    <div id="searchResultsContent"></div>
                </div>

                <!-- æ‰€æœ‰è©³ç´°è—¥ç‰©åˆ—è¡¨ -->
                <div id="allDetailedList">
                    <h4>ğŸ’Š æ‰€æœ‰è©³ç´°è—¥ç‰©è³‡è¨Š</h4>
                    <div id="detailedMedicinesList">
                        <div style="padding: 40px; text-align: center; color: #7f8c8d; background: rgba(248, 249, 250, 0.5); border-radius: 8px;">
                            <div>ğŸ“‹ æš«ç„¡è©³ç´°è—¥ç‰©è³‡è¨Š</div>
                            <div style="margin-top: 10px; font-size: 14px;">è«‹é†«å¸«å…ˆåœ¨é†«ç”Ÿå·¥ä½œå°å¡«å¯«è©³ç´°è³‡è¨Š</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°è³‡è¨Šæ¨¡æ…‹æ¡† -->
        <div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 900px; width: 90%; max-height: 90%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="modalTitle">è—¥ç‰©è©³ç´°è³‡è¨Š</h3>
                    <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <div id="modalContent"></div>
                <div style="margin-top: 25px; text-align: right;">
                    <button class="btn btn-info" onclick="exportDetailJSON()">ğŸ“„ åŒ¯å‡ºJSON</button>
                    <button class="btn btn-danger" onclick="closeDetailModal()">é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- JSON é è¦½æ¨¡æ…‹æ¡† -->
        <div id="jsonModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ“„ JSON è³‡æ–™é è¦½</h3>
                    <button onclick="closeJsonModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <pre id="jsonContent" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-info" onclick="copyJsonToClipboard()">ğŸ“‹ è¤‡è£½</button>
                    <button class="btn btn-success" onclick="downloadJson()">ğŸ’¾ ä¸‹è¼‰</button>
                    <button class="btn btn-danger" onclick="closeJsonModal()">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const API_BASE = 'http://localhost:8000';
        let basicMedicinesData = [];
        let detailedMedicinesData = {};
        let basicMedicineHot = null;
        let currentJsonData = null;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadBasicMedicines();
            loadDetailedMedicines();
        });

        // è¼‰å…¥åŸºæœ¬è—¥ç‰©è³‡æ–™
        async function loadBasicMedicines() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/`);
                if (response.ok) {
                    basicMedicinesData = await response.json();
                    updateStatistics();
                    initBasicMedicineTable();
                    console.log(`âœ… è¼‰å…¥äº† ${basicMedicinesData.length} å€‹åŸºæœ¬è—¥ç‰©`);
                } else {
                    showMessage('è¼‰å…¥åŸºæœ¬è—¥ç‰©å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥åŸºæœ¬è—¥ç‰©éŒ¯èª¤:', error);
                showMessage('é€£æ¥APIå¤±æ•—', 'error');
            }
        }

        // è¼‰å…¥è©³ç´°è—¥ç‰©è³‡æ–™
        async function loadDetailedMedicines() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed/`);
                if (response.ok) {
                    detailedMedicinesData = await response.json();
                    updateStatistics();
                    renderDetailedMedicinesList();
                    console.log(`âœ… è¼‰å…¥äº† ${Object.keys(detailedMedicinesData).length} å€‹è©³ç´°è—¥ç‰©è³‡è¨Š`);
                } else {
                    showMessage('è¼‰å…¥è©³ç´°è—¥ç‰©è³‡è¨Šå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥è©³ç´°è—¥ç‰©éŒ¯èª¤:', error);
                showMessage('é€£æ¥APIå¤±æ•—', 'error');
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const totalBasic = basicMedicinesData.length;
            const totalDetailed = Object.keys(detailedMedicinesData).length;
            const lowStock = basicMedicinesData.filter(med => med.amount < 20).length;
            const totalStock = basicMedicinesData.reduce((sum, med) => sum + med.amount, 0);

            document.getElementById('totalMedicines').textContent = totalBasic;
            document.getElementById('detailedMedicines').textContent = totalDetailed;
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('totalStock').textContent = totalStock;
        }

        // åˆå§‹åŒ–åŸºæœ¬è—¥ç‰©è¡¨æ ¼
        function initBasicMedicineTable() {
            const container = document.getElementById('basicMedicineTable');
            
            if (basicMedicineHot) {
                basicMedicineHot.destroy();
            }

            const tableData = basicMedicinesData.map(med => [
                med.id,
                med.name,
                med.amount,
                med.usage_days,
                med.position,
                formatDate(med.create_time)
            ]);

            basicMedicineHot = new Handsontable(container, {
                data: tableData,
                colHeaders: ['ç·¨è™Ÿ', 'è—¥ç‰©åç¨±', 'åº«å­˜æ•¸é‡', 'å»ºè­°ä½¿ç”¨å¤©æ•¸', 'å­˜æ”¾ä½ç½®', 'å»ºç«‹æ™‚é–“'],
                columns: [
                    { type: 'numeric', readOnly: true },
                    { type: 'text', readOnly: true },
                    { type: 'numeric', readOnly: true },
                    { type: 'numeric', readOnly: true },
                    { type: 'text', readOnly: true },
                    { type: 'text', readOnly: true }
                ],
                rowHeaders: true,
                width: '100%',
                height: 300,
                licenseKey: 'non-commercial-and-evaluation',
                contextMenu: false,
                readOnly: true,
                stretchH: 'all'
            });
        }

        // æ¸²æŸ“è©³ç´°è—¥ç‰©æ¸…å–®
        function renderDetailedMedicinesList() {
            const container = document.getElementById('detailedMedicinesList');
            const medicines = Object.keys(detailedMedicinesData);

            if (medicines.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #7f8c8d; background: rgba(248, 249, 250, 0.5); border-radius: 8px;">
                        <div>ğŸ“‹ æš«ç„¡è©³ç´°è—¥ç‰©è³‡è¨Š</div>
                        <div style="margin-top: 10px; font-size: 14px;">è«‹é†«å¸«å…ˆåœ¨é†«ç”Ÿå·¥ä½œå°å¡«å¯«è©³ç´°è³‡è¨Š</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = medicines.map(medicineName => {
                const data = detailedMedicinesData[medicineName];
                const basicInfo = data.åŸºæœ¬è³‡è¨Š || {};
                const appearance = data.å¤–è§€ || {};
                
                return `
                    <div style="border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 15px; background: white; cursor: pointer; transition: all 0.3s ease;" 
                         onmouseover="this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'"
                         onclick="showDetailModal('${medicineName}')">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                                    ğŸ’Š ${medicineName}
                                    ${basicInfo.è£½é€ å•† ? `<span style="font-size: 12px; background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 2px 8px; border-radius: 4px;">${basicInfo.è£½é€ å•†}</span>` : ''}
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                    ${basicInfo.åŠ‘é‡ ? `<div><strong>åŠ‘é‡:</strong> ${basicInfo.åŠ‘é‡}</div>` : ''}
                                    ${appearance.é¡è‰² ? `<div><strong>é¡è‰²:</strong> ${appearance.é¡è‰²}</div>` : ''}
                                    ${appearance.å½¢ç‹€ ? `<div><strong>å½¢ç‹€:</strong> ${appearance.å½¢ç‹€}</div>` : ''}
                                    ${data.å„²å­˜æ¢ä»¶ ? `<div><strong>å„²å­˜:</strong> ${data.å„²å­˜æ¢ä»¶}</div>` : ''}
                                </div>
                                ${data.è—¥ç‰©æè¿° ? `<p style="color: #7f8c8d; margin: 0; line-height: 1.4;">${data.è—¥ç‰©æè¿°}</p>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <button class="btn btn-info" style="padding: 8px 15px; font-size: 12px;" onclick="event.stopPropagation(); showDetailModal('${medicineName}')">
                                    ğŸ“‹ æŸ¥çœ‹è©³æƒ…
                                </button>
                                <div style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">
                                    ${data.å»ºç«‹æ™‚é–“ ? formatDate(data.å»ºç«‹æ™‚é–“) : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æœå°‹è—¥ç‰©
        async function searchMedicine() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showMessage('è«‹è¼¸å…¥æœå°‹é—œéµå­—', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed/${encodeURIComponent(searchTerm)}`);
                if (response.ok) {
                    const data = await response.json();
                    showSearchResults([{name: searchTerm, data: data}]);
                } else {
                    showSearchResults([]);
                }
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showMessage('æœå°‹å¤±æ•—', 'error');
            }
        }

        // æŒ‰ç·¨è™Ÿæœå°‹
        async function searchByCode() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showMessage('è«‹è¼¸å…¥åŒ…è£ç·¨è™Ÿ', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/medicine/search/code/${encodeURIComponent(searchTerm)}`);
                if (response.ok) {
                    const results = await response.json();
                    const resultArray = Object.keys(results).map(name => ({
                        name: name,
                        data: results[name]
                    }));
                    showSearchResults(resultArray);
                } else {
                    showSearchResults([]);
                }
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showMessage('æœå°‹å¤±æ•—', 'error');
            }
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function showSearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            const searchStatus = document.getElementById('searchStatus');
            const searchResultsContent = document.getElementById('searchResultsContent');
            const allDetailedList = document.getElementById('allDetailedList');

            searchStatus.textContent = `æ‰¾åˆ° ${results.length} å€‹çµæœ`;
            
            if (results.length === 0) {
                searchResultsContent.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #7f8c8d; background: rgba(248, 249, 250, 0.5); border-radius: 8px;">
                        <div>ğŸ” æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è—¥ç‰©</div>
                        <div style="margin-top: 10px; font-size: 14px;">è«‹æª¢æŸ¥æœå°‹é—œéµå­—æˆ–å˜—è©¦å…¶ä»–æœå°‹æ–¹å¼</div>
                    </div>
                `;
            } else {
                searchResultsContent.innerHTML = results.map(result => {
                    const data = result.data;
                    const basicInfo = data.åŸºæœ¬è³‡è¨Š || {};
                    const appearance = data.å¤–è§€ || {};
                    
                    return `
                        <div style="border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 15px; background: white;">
                            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">ğŸ¯ ${result.name}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${basicInfo.åŠ‘é‡ ? `<div><strong>åŠ‘é‡:</strong> ${basicInfo.åŠ‘é‡}</div>` : ''}
                                ${basicInfo.è£½é€ å•† ? `<div><strong>è£½é€ å•†:</strong> ${basicInfo.è£½é€ å•†}</div>` : ''}
                                ${appearance.é¡è‰² ? `<div><strong>é¡è‰²:</strong> ${appearance.é¡è‰²}</div>` : ''}
                                ${appearance.å½¢ç‹€ ? `<div><strong>å½¢ç‹€:</strong> ${appearance.å½¢ç‹€}</div>` : ''}
                            </div>
                            ${data.è—¥ç‰©æè¿° ? `<p style="margin: 15px 0 0 0; color: #7f8c8d;">${data.è—¥ç‰©æè¿°}</p>` : ''}
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="showDetailModal('${result.name}')">ğŸ“‹ æŸ¥çœ‹å®Œæ•´è©³æƒ…</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            searchResults.style.display = 'block';
            allDetailedList.style.display = 'none';
        }

        // é¡¯ç¤ºå…¨éƒ¨è©³ç´°è³‡è¨Š
        function loadAllDetailed() {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('allDetailedList').style.display = 'block';
            document.getElementById('searchInput').value = '';
        }

        // é¡¯ç¤ºè©³ç´°è³‡è¨Šæ¨¡æ…‹æ¡†
        function showDetailModal(medicineName) {
            const data = detailedMedicinesData[medicineName];
            if (!data) {
                showMessage('æ‰¾ä¸åˆ°è©²è—¥ç‰©çš„è©³ç´°è³‡è¨Š', 'error');
                return;
            }

            document.getElementById('modalTitle').textContent = `ğŸ’Š ${medicineName} - è©³ç´°è³‡è¨Š`;
            document.getElementById('modalContent').innerHTML = generateDetailContent(medicineName, data);
            document.getElementById('detailModal').style.display = 'block';
            currentJsonData = {medicineName: medicineName, data: data};
        }

        // ç”Ÿæˆè©³ç´°å…§å®¹HTML
        function generateDetailContent(medicineName, data) {
            let html = '';

            // åŸºæœ¬è³‡è¨Š
            if (data.åŸºæœ¬è³‡è¨Š) {
                html += `
                    <div class="form-section">
                        <h4>ğŸ“‹ åŸºæœ¬è³‡è¨Š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${Object.entries(data.åŸºæœ¬è³‡è¨Š).map(([key, value]) => 
                                `<div><strong>${key}:</strong> ${value}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // å¤–è§€
            if (data.å¤–è§€) {
                html += `
                    <div class="form-section">
                        <h4>ğŸ‘ï¸ å¤–è§€ç‰¹å¾µ</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${Object.entries(data.å¤–è§€).map(([key, value]) => 
                                `<div><strong>${key}:</strong> ${value}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // è—¥ç‰©æè¿°
            if (data.è—¥ç‰©æè¿°) {
                html += `
                    <div class="form-section">
                        <h4>ğŸ“ è—¥ç‰©æè¿°</h4>
                        <p style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 0; line-height: 1.6;">${data.è—¥ç‰©æè¿°}</p>
                    </div>
                `;
            }

            // å‰¯ä½œç”¨
            if (data.ä¸»è¦å‰¯ä½œç”¨) {
                html += `
                    <div class="form-section">
                        <h4>âš ï¸ ä¸»è¦å‰¯ä½œç”¨</h4>
                        <p style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 8px; margin: 0; line-height: 1.6; color: #c0392b;">${data.ä¸»è¦å‰¯ä½œç”¨}</p>
                    </div>
                `;
            }

            // å…¶ä»–è³‡è¨Š
            const otherFields = ['å„²å­˜æ¢ä»¶', 'æœ‰æ•ˆæœŸé™', 'å…¶ä»–å‚™è¨»'];
            const otherInfo = otherFields.filter(field => data[field]).map(field => 
                `<div><strong>${field}:</strong> ${data[field]}</div>`
            ).join('');

            if (otherInfo) {
                html += `
                    <div class="form-section">
                        <h4>â„¹ï¸ å…¶ä»–è³‡è¨Š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${otherInfo}
                        </div>
                    </div>
                `;
            }

            // ç³»çµ±è³‡è¨Š
            html += `
                <div class="form-section">
                    <h4>ğŸ”§ ç³»çµ±è³‡è¨Š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        ${data.å»ºç«‹æ™‚é–“ ? `<div><strong>å»ºç«‹æ™‚é–“:</strong> ${formatDate(data.å»ºç«‹æ™‚é–“)}</div>` : ''}
                        ${data.å»ºç«‹äººå“¡ ? `<div><strong>å»ºç«‹äººå“¡:</strong> ${data.å»ºç«‹äººå“¡}</div>` : ''}
                    </div>
                </div>
            `;

            return html;
        }

        // é—œé–‰è©³ç´°è³‡è¨Šæ¨¡æ…‹æ¡†
        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentJsonData = null;
        }

        // åŒ¯å‡ºè©³ç´°è³‡è¨ŠJSON
        function exportDetailJSON() {
            if (!currentJsonData) {
                showMessage('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'warning');
                return;
            }

            document.getElementById('jsonContent').textContent = JSON.stringify(currentJsonData.data, null, 2);
            document.getElementById('jsonModal').style.display = 'block';
        }

        // é—œé–‰JSONæ¨¡æ…‹æ¡†
        function closeJsonModal() {
            document.getElementById('jsonModal').style.display = 'none';
        }

        // è¤‡è£½JSONåˆ°å‰ªè²¼æ¿
        function copyJsonToClipboard() {
            const jsonContent = document.getElementById('jsonContent').textContent;
            navigator.clipboard.writeText(jsonContent).then(() => {
                showMessage('JSONå·²è¤‡è£½åˆ°å‰ªè²¼æ¿', 'success');
            }).catch(() => {
                showMessage('è¤‡è£½å¤±æ•—', 'error');
            });
        }

        // ä¸‹è¼‰JSONæ–‡ä»¶
        function downloadJson() {
            if (!currentJsonData) return;
            
            const jsonContent = JSON.stringify(currentJsonData.data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentJsonData.medicineName}_è©³ç´°è³‡è¨Š.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('JSONæ–‡ä»¶ä¸‹è¼‰æˆåŠŸ', 'success');
        }

        // åŒ¯å‡ºåŸºæœ¬è³‡æ–™
        function exportBasicData() {
            if (basicMedicinesData.length === 0) {
                showMessage('æ²’æœ‰å¯åŒ¯å‡ºçš„åŸºæœ¬è³‡æ–™', 'warning');
                return;
            }

            const csvContent = generateBasicCSV(basicMedicinesData);
            downloadCSV(csvContent, `åŸºæœ¬è—¥ç‰©è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // ç”ŸæˆåŸºæœ¬è³‡æ–™CSV
        function generateBasicCSV(medicines) {
            const headers = ['ç·¨è™Ÿ', 'è—¥ç‰©åç¨±', 'åº«å­˜æ•¸é‡', 'å»ºè­°ä½¿ç”¨å¤©æ•¸', 'å­˜æ”¾ä½ç½®', 'å»ºç«‹æ™‚é–“'];
            const csvRows = [headers.join(',')];

            medicines.forEach(medicine => {
                const row = [
                    medicine.id,
                    `"${medicine.name}"`,
                    medicine.amount,
                    medicine.usage_days,
                    `"${medicine.position}"`,
                    medicine.create_time
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // ä¸‹è¼‰CSVæ–‡ä»¶
        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('CSVæ–‡ä»¶ä¸‹è¼‰æˆåŠŸ', 'success');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'ç„¡æ—¥æœŸ';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            const alertColor = type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#3498db';
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 3000;
                background: ${alertColor}; color: white; padding: 15px 20px;
                border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-weight: 500; max-width: 300px;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    document.body.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>
</body>
</html> 