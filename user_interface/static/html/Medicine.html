<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫院藥物管理系統 - 藥物管理</title>

    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>

    <!-- 樣式表 -->
    <link rel="stylesheet" href="../css/unified_style.css">
</head>
<body>
    <div class="sidebar">
        <h2>醫院管理系統</h2>
        <button onclick="location.href='doctor.html'">醫生管理</button>
        <button onclick="location.href='Medicine.html'" class="active">藥物管理</button>
        <button onclick="location.href='Prescription.html'">處方管理</button>
    </div>

    <div class="main-content">
        <div class="header fade-in">
            <h1>藥物管理系統</h1>
            <p>醫院藥物庫存管理與查詢系統</p>
        </div>

        <!-- 統計卡片 -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>系統統計</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="totalMedicines">0</div>
                        <div style="color: #7f8c8d;">總藥物數量</div>
                    </div>
                    <div style="padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="completeMedicines">0</div>
                        <div style="color: #7f8c8d;">完整資料藥物</div>
                    </div>
                    <div style="padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="lowStock">0</div>
                        <div style="color: #7f8c8d;">庫存不足</div>
                    </div>
                    <div style="padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9b59b6;" id="totalStock">0</div>
                        <div style="color: #7f8c8d;">總庫存量</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 基本藥物管理 -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>基本藥物管理</h3>
                    <div>
                        <button class="btn btn-info" onclick="loadBasicMedicines()">載入資料</button>
                        <button class="btn btn-success" onclick="exportBasicData()">導出JSON</button>
                    </div>
                </div>
                <div id="basicMedicineTable" class="hot-container"></div>
            </div>
        </div>

        <!-- 詳細藥物查詢 -->
        <div class="card fade-in">
            <div style="padding: 20px;">
                <h3>詳細藥物查詢</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    輸入藥物名稱或代碼進行詳細查詢
                </p>

                <!-- 搜尋控制項 -->
                <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 25px; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                        <label for="searchInput">搜尋藥物</label>
                        <input type="text" id="searchInput" placeholder="輸入藥物名稱..." style="width: 100%;">
                    </div>
                    <button class="btn btn-primary" onclick="searchMedicine()">搜尋</button>
                    <button class="btn btn-info" onclick="searchByCode()">代碼搜尋</button>
                    <button class="btn btn-success" onclick="loadAllDetailed()">載入全部</button>
                </div>

                <!-- 搜尋結果 -->
                <div id="searchResults" style="display: none;">
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
                        <h4 style="margin: 0; color: #3498db;">搜尋結果</h4>
                        <p style="margin: 5px 0 0 0; color: #7f8c8d;" id="searchStatus">找到 0 個結果</p>
                    </div>
                    <div id="searchResultsContent"></div>
                </div>

                <!-- 全部詳細藥物列表 -->
                <div id="allDetailedList">
                    <h4>所有詳細藥物資料</h4>
                    <div id="detailedMedicinesList">
                        <div style="padding: 40px; text-align: center; color: #7f8c8d; background: rgba(248, 249, 250, 0.5); border-radius: 8px;">
                            <p>點擊「載入全部」按鈕來顯示所有詳細藥物資料</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let basicHot;
        let currentData = [];

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeBasicTable();
            updateStatistics();
        });

        // 初始化基本藥物表格
        function initializeBasicTable() {
            const container = document.getElementById('basicMedicineTable');
            
            basicHot = new Handsontable(container, {
                data: [],
                colHeaders: ['ID', '藥物名稱', '數量', '使用天數', '位置', '建立時間'],
                columns: [
                    {data: 'id', readOnly: true, width: 60},
                    {data: 'name', width: 150},
                    {data: 'amount', type: 'numeric', width: 80},
                    {data: 'usage_days', type: 'numeric', width: 100},
                    {data: 'position', width: 100},
                    {data: 'create_time', readOnly: true, width: 150}
                ],
                rowHeaders: true,
                height: 400,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                contextMenu: true,
                manualRowResize: true,
                manualColumnResize: true,
                filters: true,
                dropdownMenu: true,
                afterChange: function(changes, source) {
                    if (source === 'edit') {
                        changes.forEach(change => {
                            const [row, prop, oldValue, newValue] = change;
                            if (oldValue !== newValue) {
                                updateMedicine(row, prop, newValue);
                            }
                        });
                    }
                }
            });
        }

        // 載入基本藥物資料
        async function loadBasicMedicines() {
            try {
                const response = await fetch('/api/medicine/');
                const data = await response.json();
                
                currentData = data;
                basicHot.loadData(data);
                updateStatistics();
                
                showMessage('資料載入成功', 'success');
            } catch (error) {
                console.error('載入資料失敗:', error);
                showMessage('載入資料失敗', 'error');
            }
        }

        // 更新藥物資料
        async function updateMedicine(row, prop, value) {
            const medicine = currentData[row];
            if (!medicine || !medicine.id) return;

            try {
                const response = await fetch(`/api/medicine/${medicine.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: medicine.name,
                        amount: medicine.amount,
                        usage_days: medicine.usage_days,
                        position: medicine.position
                    })
                });

                if (response.ok) {
                    showMessage('更新成功', 'success');
                    updateStatistics();
                } else {
                    showMessage('更新失敗', 'error');
                }
            } catch (error) {
                console.error('更新失敗:', error);
                showMessage('更新失敗', 'error');
            }
        }

        // 搜尋藥物
        async function searchMedicine() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showMessage('請輸入搜尋關鍵字', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/medicine/search/detailed/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                displaySearchResults(data, query);
            } catch (error) {
                console.error('搜尋失敗:', error);
                showMessage('搜尋失敗', 'error');
            }
        }

        // 代碼搜尋
        async function searchByCode() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showMessage('請輸入藥物代碼', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/medicine/search/code/${encodeURIComponent(query)}`);
                const data = await response.json();
                
                displaySearchResults(data, `代碼: ${query}`);
            } catch (error) {
                console.error('代碼搜尋失敗:', error);
                showMessage('代碼搜尋失敗', 'error');
            }
        }

        // 載入所有詳細藥物
        async function loadAllDetailed() {
            try {
                const response = await fetch('/api/medicine/detailed/');
                const data = await response.json();
                
                displayAllDetailed(data);
            } catch (error) {
                console.error('載入詳細資料失敗:', error);
                showMessage('載入詳細資料失敗', 'error');
            }
        }

        // 顯示搜尋結果
        function displaySearchResults(data, query) {
            const resultsDiv = document.getElementById('searchResults');
            const statusDiv = document.getElementById('searchStatus');
            const contentDiv = document.getElementById('searchResultsContent');
            
            const count = Object.keys(data).length;
            statusDiv.textContent = `找到 ${count} 個結果 (搜尋: ${query})`;
            
            let html = '';
            for (const [name, details] of Object.entries(data)) {
                html += createMedicineCard(name, details);
            }
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // 顯示所有詳細藥物
        function displayAllDetailed(data) {
            const listDiv = document.getElementById('detailedMedicinesList');
            
            if (Object.keys(data).length === 0) {
                listDiv.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d;">暫無詳細藥物資料</div>';
                return;
            }
            
            let html = '';
            for (const [name, details] of Object.entries(data)) {
                html += createMedicineCard(name, details);
            }
            
            listDiv.innerHTML = html;
        }

        // 建立藥物卡片
        function createMedicineCard(name, details) {
            const basicInfo = details.basic_info || {};
            const detailedInfo = details.detailed_info || {};
            
            return `
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">${name}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <h5 style="color: #3498db; margin-bottom: 10px;">基本資訊</h5>
                            <p><strong>數量:</strong> ${basicInfo.amount || 'N/A'}</p>
                            <p><strong>位置:</strong> ${basicInfo.position || 'N/A'}</p>
                            <p><strong>使用天數:</strong> ${basicInfo.usage_days || 'N/A'}</p>
                        </div>
                        
                        <div>
                            <h5 style="color: #27ae60; margin-bottom: 10px;">詳細資訊</h5>
                            <p><strong>製造商:</strong> ${detailedInfo.manufacturer || 'N/A'}</p>
                            <p><strong>成分:</strong> ${detailedInfo.ingredients || 'N/A'}</p>
                            <p><strong>適應症:</strong> ${detailedInfo.indications || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 導出基本資料
        async function exportBasicData() {
            try {
                const response = await fetch('/api/export/medicines/basic');
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'basic_medicines.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showMessage('導出成功', 'success');
            } catch (error) {
                console.error('導出失敗:', error);
                showMessage('導出失敗', 'error');
            }
        }

        // 更新統計資料
        async function updateStatistics() {
            try {
                const response = await fetch('/api/medicine/');
                const data = await response.json();
                
                const totalMedicines = data.length;
                const totalStock = data.reduce((sum, med) => sum + (med.amount || 0), 0);
                const lowStock = data.filter(med => (med.amount || 0) < 10).length;
                const completeMedicines = data.filter(med => med.name && med.amount && med.position).length;
                
                document.getElementById('totalMedicines').textContent = totalMedicines;
                document.getElementById('totalStock').textContent = totalStock;
                document.getElementById('lowStock').textContent = lowStock;
                document.getElementById('completeMedicines').textContent = completeMedicines;
            } catch (error) {
                console.error('更新統計失敗:', error);
            }
        }

        // 顯示訊息
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }
    </script>
</body>
</html>