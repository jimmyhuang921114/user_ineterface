<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 API功能測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .button-group { margin: 15px 0; }
        .btn { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; transform: translateY(-1px); }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; transform: translateY(-1px); }
        .result { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .nav-links { text-align: center; margin: 20px 0; }
        .nav-links a { 
            display: inline-block; 
            margin: 0 10px; 
            padding: 10px 20px; 
            background: #6c757d; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px;
            transition: background 0.3s;
        }
        .nav-links a:hover { background: #545b62; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 醫院藥物管理系統 - API功能測試</h1>
        
        <div class="nav-links">
            <a href="/doctor.html">👨‍⚕️ 醫生界面</a>
            <a href="/medicine_integrated.html">💊 整合藥物管理</a>
            <a href="/Prescription.html">📋 處方籤管理</a>
            <a href="/docs">📖 API文檔</a>
        </div>

        <!-- 基本藥物API測試 -->
        <div class="test-section">
            <h2>💊 基本藥物API測試</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testBasicMedicinesGet()">📋 獲取基本藥物</button>
                <button class="btn btn-success" onclick="testBasicMedicinePost()">➕ 新增基本藥物</button>
                <button class="btn btn-info" onclick="testROS2BasicMedicines()">🤖 ROS2獲取基本藥物</button>
            </div>
            <div id="basicMedicineResult" class="result" style="display: none;"></div>
        </div>

        <!-- 詳細藥物API測試 -->
        <div class="test-section">
            <h2>📊 詳細藥物API測試</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testDetailedMedicinesGet()">📋 獲取詳細藥物</button>
                <button class="btn btn-success" onclick="testDetailedMedicinePost()">➕ 新增詳細藥物</button>
                <button class="btn btn-info" onclick="testROS2DetailedMedicines()">🤖 ROS2獲取詳細藥物</button>
            </div>
            <div id="detailedMedicineResult" class="result" style="display: none;"></div>
        </div>

        <!-- 處方籤API測試 -->
        <div class="test-section">
            <h2>📋 處方籤API測試</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testPrescriptionsGet()">📋 獲取處方籤</button>
                <button class="btn btn-success" onclick="testPrescriptionPost()">➕ 新增處方籤</button>
                <button class="btn btn-info" onclick="testROS2Prescriptions()">🤖 ROS2獲取處方籤</button>
            </div>
            <div id="prescriptionResult" class="result" style="display: none;"></div>
        </div>

        <!-- 整合API測試 -->
        <div class="test-section">
            <h2>🔗 整合API測試</h2>
            <div class="button-group">
                <button class="btn btn-info" onclick="testROS2IntegratedMedicine()">🤖 ROS2獲取整合藥物</button>
                <button class="btn btn-primary" onclick="testAllAPIs()">🚀 測試所有API</button>
                <button class="btn btn-success" onclick="clearAllResults()">🗑️ 清空結果</button>
            </div>
            <div id="integratedResult" class="result" style="display: none;"></div>
        </div>

        <!-- 整體測試結果 -->
        <div class="test-section">
            <h2>📊 整體測試結果</h2>
            <div id="overallResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        function showResult(elementId, content, success = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = JSON.stringify(content, null, 2);
            element.style.background = success ? '#d4edda' : '#f8d7da';
        }

        function showError(elementId, error) {
            showResult(elementId, { error: error.message || error }, false);
        }

        // 基本藥物API測試
        async function testBasicMedicinesGet() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/basic`);
                const data = await response.json();
                showResult('basicMedicineResult', data, response.ok);
            } catch (error) {
                showError('basicMedicineResult', error);
            }
        }

        async function testBasicMedicinePost() {
            try {
                const testData = {
                    name: "測試藥物_" + Date.now(),
                    amount: 50,
                    usage_days: 7,
                    position: "TEST-A1",
                    manufacturer: "測試製藥公司",
                    dosage: "100mg"
                };
                
                const response = await fetch(`${API_BASE}/api/medicine/basic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                showResult('basicMedicineResult', data, response.ok);
            } catch (error) {
                showError('basicMedicineResult', error);
            }
        }

        async function testROS2BasicMedicines() {
            try {
                const response = await fetch(`${API_BASE}/api/ros2/medicine/basic`);
                const data = await response.json();
                showResult('basicMedicineResult', data, response.ok);
            } catch (error) {
                showError('basicMedicineResult', error);
            }
        }

        // 詳細藥物API測試
        async function testDetailedMedicinesGet() {
            try {
                const response = await fetch(`${API_BASE}/api/medicine/detailed`);
                const data = await response.json();
                showResult('detailedMedicineResult', data, response.ok);
            } catch (error) {
                showError('detailedMedicineResult', error);
            }
        }

        async function testDetailedMedicinePost() {
            try {
                const testData = {
                    medicine_name: "測試藥物_" + Date.now(),
                    description: "這是一個測試用的藥物描述",
                    side_effects: "可能的副作用包括頭暈",
                    appearance: {
                        color: "白色",
                        shape: "圓形"
                    },
                    storage_conditions: "室溫保存",
                    expiry_date: "2025-12-31",
                    notes: "測試用藥物，請勿實際使用"
                };
                
                const response = await fetch(`${API_BASE}/api/medicine/detailed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                showResult('detailedMedicineResult', data, response.ok);
            } catch (error) {
                showError('detailedMedicineResult', error);
            }
        }

        async function testROS2DetailedMedicines() {
            try {
                const response = await fetch(`${API_BASE}/api/ros2/medicine/detailed`);
                const data = await response.json();
                showResult('detailedMedicineResult', data, response.ok);
            } catch (error) {
                showError('detailedMedicineResult', error);
            }
        }

        // 處方籤API測試
        async function testPrescriptionsGet() {
            try {
                const response = await fetch(`${API_BASE}/api/prescription/`);
                const data = await response.json();
                showResult('prescriptionResult', data, response.ok);
            } catch (error) {
                showError('prescriptionResult', error);
            }
        }

        async function testPrescriptionPost() {
            try {
                const testData = {
                    patient_name: "測試患者_" + Date.now(),
                    doctor_name: "測試醫師",
                    diagnosis: "測試診斷",
                    medicines: [{
                        medicine_name: "測試藥物",
                        dosage: "100mg",
                        frequency: "每日三次",
                        duration: "7天",
                        instructions: "飯後服用"
                    }],
                    prescription_date: new Date().toISOString().split('T')[0]
                };
                
                const response = await fetch(`${API_BASE}/api/prescription/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                showResult('prescriptionResult', data, response.ok);
            } catch (error) {
                showError('prescriptionResult', error);
            }
        }

        async function testROS2Prescriptions() {
            try {
                const response = await fetch(`${API_BASE}/api/ros2/prescription`);
                const data = await response.json();
                showResult('prescriptionResult', data, response.ok);
            } catch (error) {
                showError('prescriptionResult', error);
            }
        }

        // 整合API測試
        async function testROS2IntegratedMedicine() {
            try {
                const medicineName = "測試藥物_" + Date.now();
                const response = await fetch(`${API_BASE}/api/ros2/medicine/integrated/${medicineName}`);
                const data = await response.json();
                showResult('integratedResult', data, response.ok);
            } catch (error) {
                showError('integratedResult', error);
            }
        }

        // 測試所有API
        async function testAllAPIs() {
            const results = [];
            const tests = [
                { name: '基本藥物GET', func: testBasicMedicinesGet },
                { name: '詳細藥物GET', func: testDetailedMedicinesGet },
                { name: '處方籤GET', func: testPrescriptionsGet },
                { name: 'ROS2基本藥物', func: testROS2BasicMedicines },
                { name: 'ROS2詳細藥物', func: testROS2DetailedMedicines },
                { name: 'ROS2處方籤', func: testROS2Prescriptions }
            ];

            for (const test of tests) {
                try {
                    await test.func();
                    results.push(`✅ ${test.name}: 成功`);
                } catch (error) {
                    results.push(`❌ ${test.name}: 失敗 - ${error.message}`);
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // 延遲500ms
            }

            showResult('overallResult', {
                message: '所有API測試完成',
                results: results,
                timestamp: new Date().toISOString()
            });
        }

        // 清空所有結果
        function clearAllResults() {
            ['basicMedicineResult', 'detailedMedicineResult', 'prescriptionResult', 'integratedResult', 'overallResult'].forEach(id => {
                const element = document.getElementById(id);
                element.style.display = 'none';
                element.textContent = '';
            });
        }

        // 頁面載入時顯示歡迎訊息
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧪 API測試頁面已載入');
            showResult('overallResult', {
                message: '歡迎使用API測試工具',
                available_endpoints: [
                    'GET /api/medicine/basic - 獲取基本藥物',
                    'POST /api/medicine/basic - 新增基本藥物',
                    'GET /api/medicine/detailed - 獲取詳細藥物',
                    'POST /api/medicine/detailed - 新增詳細藥物',
                    'GET /api/prescription/ - 獲取處方籤',
                    'POST /api/prescription/ - 新增處方籤',
                    'GET /api/ros2/medicine/basic - ROS2獲取基本藥物',
                    'GET /api/ros2/medicine/detailed - ROS2獲取詳細藥物',
                    'GET /api/ros2/prescription - ROS2獲取處方籤',
                    'GET /api/ros2/medicine/integrated/{name} - ROS2獲取整合藥物'
                ],
                timestamp: new Date().toISOString()
            });
        });
    </script>
</body>
</html>